<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <title>MAK Printers</title>

    <style>
      <!-- Logo CSS -- > .mak-logo {
        padding: 0px;
        margin: 0px;
      }
      html {
        scroll-behavior: smooth;
      }

      .mak-brand {
        font-weight: 700;
        font-family: Tahoma;
        color: #ffffff;
        font-size: 22px;
        padding-left: 10px;
      }

      .mak-sub {
        font-family: Tahoma;
        font-weight: 400;
        font-size: 22px;
        color: #ffffff;
        letter-spacing: 1px;
      }
    </style>
    <style>
      /*Raddi Style*/
      #update-raddi-btn,
      #delete-raddi-btn {
        display: none;
        margin-right: 10px;
      }
    </style>
    <style>
      /* ‚úÖ Print Page Setup */

      			/* ‚úÖ Print Page Setup */
      		@page {
      		  size: A4 portrait;
      		  margin: 10mm;
      		}

      		/* ‚úÖ General Print Overrides */
      		@media print {
      		  body {
      			background: white !important;
      			border-spacing: 0 !important;
      			border-collapse: collapse !important;
      			width: 100% !important;
      			zoom: 80%;
      		  }

      		  /* Hide non-print elements */
      		  .btn,
      		  input,
      		  select,
      		  .footer-note {
      			display: none !important;
      			visibility: hidden !important;
      		  }

      		  /* Invoice Table Print Isolation */
      		  body * {
      			visibility: hidden;
      		  }

      		  #InvoiceTable,
      		  #InvoiceTable * {
      			visibility: visible;
      		  }

      		  #InvoiceTable {
      			position: absolute;
      			top: 0;
      			left: 0;
      			width: 100%;
      			max-width: 100%;
      			transform: scale(1);
      			transform-origin: top left;
      			border-spacing: 0 !important;
      			border-collapse: collapse !important;
      		  }
    </style>
    <style>
      /* Tax Invoice Styles */
      .table-container {
        width: 100%;
        overflow-x: auto;
        padding: 0;
        border: 0px solid #000;
      }
      #InvoiceTable {
        width: 100%;
        border-collapse: collapse;
        font-family: "Lato", sans-serif;
      }
      #InvoiceTable td,
      #InvoiceTable th {
        padding: 10px;
        vertical-align: top;
      }
      .sub-table {
        border-collapse: collapse;
        width: 100%;
        text-align: left;
      }
      .sub-table td {
        border: 0px solid#000;
        padding: 0; /* tight layout */
      }
      .sub-table tr {
        border: 0px solid#000;
        padding: 0; /* tight layout */
      }
    </style>
    <style>
      /* Table style*/
      table {
        width: 100%;
        border-collapse: collapse; /* Ensures borders don't double up */
        text-align: center; /* Center-align content */
      }

      th,
      td {
        border: 1px solid #000; /* Adjust border color as needed */
        padding: 8px;
      }

      .table-wrapper {
        overflow-x: auto;
        width: 100%;
      }
      .table-container {
        width: 100%;
        overflow-x: auto;
      }
      #InvoiceTable {
        width: max-content;
        border-collapse: collapse;
        margin: auto; /* Centers the table horizontally */
      }
      #quotationDetailsTable {
        min-width: 800px; /* You can adjust this based on how many headers you're injecting */
        border-collapse: collapse;
      }
    </style>
    <style>
      /* Body Style */
      body {
        margin: 0;
        font-family: "Segoe UI", sans-serif;
        overflow-x: hidden;
      }
      .scroll-container {
        width: 100%;
        overflow-x: auto;
      }

      .scroll-container table {
        width: 100%;
        min-width: 600px; /* Prevents table from shrinking too much */
        border-collapse: collapse;
        white-space: nowrap;
      }
      label {
        padding: 5px;
      }
      .inp1 {
        width: 70px;
      }
      .head2 {
        font-size: 15px;
        font-weight: 500;
        padding: 10px;
        text-align: center;
      }
      input,
      select {
        margin: 5px;
        padding-left: 5px;
        border: solid;
        border-width: thin;
        border-color: antiquewhite;
      }
    </style>
    <style>
      /* Side Menu */
      #sideMenu {
        position: fixed;
        top: 60px;
        left: -200px;
        width: 200px;
        height: calc(
          100vh - 60px
        ); /* Adjusts the height so it doesn't overflow */
        background-color: #444;
        color: white;
        transition: left 0.3s ease;
        z-index: 500;
        padding-top: 20px;
      }
      #menuToggle {
        position: absolute;
        top: 0px;
        left: 10px;
        cursor: pointer;
        position: relative; /* now it moves with the header */
        margin-right: 10px;
        z-index: 1001; /* just in case! */
      }
      #menuToggle img {
        height: 24px;
      }
      #sideMenu a {
        display: block;
        padding: 10px;
        text-decoration: none;
        color: white;
      }
      nav a:hover {
        background: #555;
      }
      .page {
        display: none;
      }
      .page.active {
        display: block;
      }
      #sideMenu a.active {
        background-color: #666;
        font-weight: bold;
      }
    </style>
    <style>
      /* Header*/
      header {
        background: #2196f3;
        color: white;
        padding: 15px 0px;
        display: flex;
        position: sticky;
        top: 0;
        z-index: 1000;
        align-items: center;
      }
      header img {
        height: 32px;
        margin-right: 10px;
        padding-left: 10px;
      }
      header h1 {
        font-size: 15px;
        margin: 0;
      }
    </style>
    <style>
      /* Page Header*/
      .pageheader {
        background: #808080;
        color: white;
        text-align: center;
      }
    </style>
    <style>
      /* Main Container Style */
      .Main-container {
        max-width: 1300px;
        margin: 5px auto;
        background: #fff;
      }
      .section-title {
        font-size: 18px;
        margin-bottom: 10px;
        border-bottom: 1px solid #ccc;
        padding-bottom: 5px;
        color: #444;
      }
    </style>
    <style>
      /* Section1 & 2 and Sub container1 & 2 and toggle btn1 & 2*/
      .section1,
      .section2 {
        display: none;
        padding: 10px;
        margin-top: 5px;
        background-color: #eef;
      }
      .section1.visible,
      .section2.visible {
        display: block;
      }
      .toggle-btn1,
      .toggle-btn2 {
        cursor: pointer;
        margin-bottom: 5px;
      }
      .sub-container1,
      .sub-container2 {
        margin-bottom: 15px;
        box-shadow: 0 0 3px rgba(0, 0, 0, 0.1);
        border-radius: 5px;
      }
    </style>
    <style>
      /* Mycontrols Style */
      #mycontrols {
        margin: 5px auto;
        background: #fff;
        padding: 5px;
        box-shadow: 0 0 12px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
      }
    </style>
    <style>
      /* Printing Prices Style */
      #printingprice {
        margin: 5px auto;
        background: #fff;
        padding: 5px;
        box-shadow: 0 0 12px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <header>
      <!-- Header HTML -->
      <div id="menuToggle" onclick="toggleMenu()">
        <img
          id="menuIcon"
          src="https://img.icons8.com/ios-filled/50/ffffff/menu--v1.png"
          alt="Menu Icon"
        />
      </div>
      <div class="mak-logo">
        <span class="mak-brand">MAK</span>
        <span class="mak-sub">PRINTERS</span>
      </div>
    </header>
    <nav id="sideMenu">
      <!-- Side Menu HTML -->
      <div id="static-pages">
        <a href="#" onclick="showPageById('page-dashboard')">Dashboard</a>
        <a href="#" onclick="showPageById('page-quotations')">Quotations</a>
        <a href="#" onclick="showPageById('page-taxinvoices')">Tax Invoices</a>
        <a href="#" onclick="showPageById('page-raddi')">Raddi</a>
      </div>
      <div id="dynamic-pages">
        <!-- Schema-driven pages go here -->
      </div>
    </nav>

    <div id="pages">
      <!-- Pages HTML -->
      <div class="page" id="page-dashboard">
        <!-- Dashboard Page HTML -->
        <div class="pageheader">DASHBOARD</div>
        <div class="Main-container">
          <div class="sub-container1">
            <label>QUOTATION DETAILS</label>
            <button class="toggle-btn1">+</button>
            <div class="section1">
              <div class="scroll-container">
                <button
                  onclick="downloadTableAsPDF('dashboard_Qutation_Table', 'Quotation Dashboard')"
                >
                  üìÑ Download Dashboard PDF
                </button>
                <table
                  id="dashboard_Qutation_Table"
                  border="1"
                  cellspacing="0"
                  cellpadding="8"
                >
                  <thead>
                    <tr>
                      <th>S.No</th>
                      <th>Quotation ID</th>
                      <th>No of Books</th>
                      <th>Total Quantity</th>
                      <th>Paper Weight</th>
                      <th>Total Price</th>
                    </tr>
                  </thead>
                  <tbody id="dashboard_Qutation_Body">
                    <!-- Rows will be inserted here dynamically -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="sub-container1">
            <label>TAX INVOICE DETAILS</label>
            <button class="toggle-btn1">+</button>
            <div class="section1">
              <div class="scroll-container">
                <button
                  onclick="downloadTableAsPDF('dashboard_Invoice_Table', 'Tax Invoice Dashboard')"
                >
                  üìÑ Download Dashboard PDF
                </button>
                <table
                  id="dashboard_Invoice_Table"
                  border="1"
                  cellspacing="0"
                  cellpadding="8"
                >
                  <thead>
                    <tr>
                      <th>S.No</th>
                      <th>Tax Invoice ID</th>
                      <th>PDF Invoice Number</th>
                      <th>Customer Name</th>
                      <th>Invoice Date</th>
                      <th>No of Books</th>
                      <th>Total Quantity</th>
                      <th>Total GST</th>
                      <th>Total Price</th>
                    </tr>
                  </thead>
                  <tbody id="dashboard_Invoice_Body">
                    <!-- Rows will be inserted here dynamically -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="sub-container1">
            <label>RADDI DASHBORD</label>
            <button class="toggle-btn1">+</button>
            <div class="section1">
              <div class="sub-container1">
                <label>Column Headers</label>
                <button class="toggle-btn1">+</button>
                <button
                  onclick="downloadTableAsPDF('Raddi_Details_Table', 'Raddi Dashboard')"
                >
                  üìÑ Download Dashboard PDF
                </button>
                <div
                  id="raddi-filter-controls"
                  style="
                    margin-bottom: 10px;
                    padding: 10px;
                    background: #f9f9f9;
                    border-radius: 5px;
                  "
                >
                  <label for="raddi-month-filter" style="margin-right: 15px">
                    <strong>Month:</strong>
                    <select id="raddi-month-filter">
                      <option value="">-- Select Month --</option>
                      <!-- Options will be populated dynamically -->
                    </select>
                  </label>

                  <label for="raddi-year-filter">
                    <strong>Year:</strong>
                    <select id="raddi-year-filter">
                      <option value="">-- Select Year --</option>
                      <!-- Options will be populated dynamically -->
                    </select>
                  </label>
                </div>

                <div class="section1">
                  <div id="Raddi_Columns">
                    <!-- Dynamic Category columns as checkboxes-->
                    <!-- Check box for weight and Total Prices and Both ex: if i select both then for the same column two columns show show -->
                  </div>
                </div>
              </div>
              <div class="scroll-container">
                <table
                  id="Raddi_Details_Table"
                  border="1"
                  cellspacing="0"
                  cellpadding="8"
                >
                  <thead>
                    <tr id="Raddi_Header_Row">
                      <th>S.No</th>
                      <th>RADDI ID</th>
                      <th>DATE</th>
                      <th>TOTAL PRICE</th>
                    </tr>
                  </thead>
                  <tbody id="Raddi_Details_Body">
                    <!-- Rows will be inserted here dynamically -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="sub-container">
            <!-- Dynamic Dashboard Container -->
          </div>

          <div class="sub-container1">
            <label>TABLE SCHEMA BUILDER</label>
            <button class="toggle-btn1">+</button>
            <div class="section1">
              <!-- Schema Builder Section -->
              <div class="sub-container1">
                <label>TABLE SCHEMA BUILDER</label>
                <select
                  id="schemaSelector"
                  onchange="onSchemaChange(this.value)"
                ></select>
                <button onclick="createNewSchema()">New Schema</button>
                <button onclick="deleteSchema()">Delete Schema</button>

                <button class="toggle-btn1">+</button>
                <div class="section1">
                  <div>
                    <button onclick="prevColumn()">¬´</button>
                    <span id="colRecordLabel"></span>
                    <button onclick="nextColumn()">¬ª</button>
                    <button onclick="addColumn()">Add Column</button>
                    <button onclick="updateColumn()">Update Column</button>
                    <button onclick="deleteColumn()">Delete Column</button>
                    <div id="reorderControls" style="margin-top: 10px">
                      <button id="moveUpBtn" onclick="moveColumnUp()">
                        ‚¨ÜÔ∏è Move Up
                      </button>
                      <button id="moveDownBtn" onclick="moveColumnDown()">
                        ‚¨áÔ∏è Move Down
                      </button>
                    </div>
                  </div>
                  <div>
                    <label>Column Name</label
                    ><input
                      type="text"
                      id="colName"
                      placeholder="Column Name"
                    />
                    <label>Column Formula </label
                    ><input
                      type="text"
                      id="colFormula"
                      placeholder="Formula (e.g., Quantity*Rate)"
                    />
                  </div>
                  <select id="colType">
                    <option value="">-- Select Column Type --</option>
                    <option value="text">Text</option>
                    <option value="number">Number</option>
                    <option value="date">Date</option>
                  </select>
                  <label
                    ><input type="checkbox" id="colRequired" /> Mandatory</label
                  >
                </div>
              </div>

              <!-- Pages Container -->
              <div id="pages"></div>

              <div class="sub-container1">
                <label>OTHER</label>
                <button class="toggle-btn1">+</button>
                <div class="section1">
                  <button onclick="exportAllData()">üì§ Export DB</button>
                  <button onclick="triggerImport()">üì• Import DB</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="page" id="page-quotations">
        <!-- Quotations Page HTML -->
        <div class="pageheader">QUOTATIONS</div>
        <div class="Main-container">
          <div class="sub-container1">
            <label>Quotations</label>
            <select
              id="quotationIdDropdown"
              class="drp"
              onchange="handleQIDSelection()"
            >
              <option value="">-- Select Qutation --</option>
            </select>
            <button class="toggle-btn1">+</button>
            <div class="section1">
              <label
                >Customer Name :<input
                  type="text"
                  id="customerName"
                  value=""
                  placeholder="Customer Name"
              /></label>
              <label
                >Quotation Number :<input
                  type="text"
                  id="quotationNumber"
                  value=""
                  placeholder="Quotation Number"
              /></label>
              <button class="btn" onclick="deleteQuotation()">üóëÔ∏è Delete</button>
              <button
                class="btn"
                id="createQuotationBtn"
                onclick="createNewQuotation()"
              >
                ‚ûï New
              </button>
              <button class="btn" onclick="updateQuotation()">‚úèÔ∏è Update</button>
            </div>
          </div>
          <div class="sub-container1">
            <label>Book Details</label>
            <button class="toggle-btn1">+</button>
            <div class="section1">
              <div id="mycontrols">
                <button id="prevBtn">¬´</button>
                <span id="recordCount">Record 1 of X</span>
                <button id="nextBtn">¬ª</button>
                <button onclick="NewQuotationDetail()">New Entry</button>
                <button onclick="addQuotationDetail()">‚ûï</button>
                <button onclick="updateQuotationDetail()">‚úèÔ∏è</button>
                <button
                  onclick="deleteDetailByQuotationAndField7(
								  document.getElementById('quotationIdDropdown').value.trim(), 
								  document.getElementById('field7').value.trim()
								)"
                >
                  üóëÔ∏è
                </button>
                <label class="head2"
                  >Total Books: <span id="totalBooks">0</span></label
                >
                <label class="head2"
                  >Total Quantity: <span id="totalQuantity">0</span></label
                >
                <label class="head2"
                  >Total Paper Weight: <span id="totalWeight">0</span></label
                >
                <label class="head2"
                  >Total Price: <span id="totalPrice">0</span></label
                >
              </div>
              <div id="mycontrols">
                <label class="head2"
                  >Binding Rate :
                  <input type="number" id="field1" class="inp1" value="300"
                /></label>
                <label class="head2"
                  >Printing SC :
                  <input type="number" id="field2" class="inp1" value="250"
                /></label>
                <label class="head2"
                  >Printing DC :
                  <input type="number" id="field3" class="inp1" value="250"
                /></label>
                <label class="head2"
                  >Printing MC :
                  <input type="number" id="field4" class="inp1" value="250"
                /></label>
                <label class="head2"
                  >CTP Plate Price :
                  <input type="number" id="field5" class="inp1" value="320"
                /></label>
                <label class="head2"
                  >Paper Price :
                  <input type="number" id="field6" class="inp1" value="72"
                /></label>
              </div>
              <div id="mycontrols">
                <label class="head2"
                  >S.No : <input type="number" id="field7" class="inp1"
                /></label>
                <label class="head2"
                  >Book Name :
                  <input type="text" id="field8" placeholder="Book Name"
                /></label>
                <label class="head2"
                  >No of Pages :
                  <input
                    type="number"
                    id="field9"
                    class="inp1"
                    oninput="calculateTotal()"
                /></label>
                <select id="field33" class="drp">
                  <option value="DC">DC</option>
                  <option value="SC">SC</option>
                  <option value="MC">MC</option>
                </select>
                <label class="head2"
                  >Quantity :
                  <input
                    type="number"
                    id="field10"
                    class="inp1"
                    oninput="calculateTotal()"
                /></label>
                <select id="field11" class="drp">
                  <option value="lamination" selected>Lamination</option>
                  <option value="without lamination">Without Lamination</option>
                </select>
              </div>
              <div class="sub-container2">
                <div id="mycontrols">
                  <label class="head2">Printing Price : </label
                  ><input type="number" id="field15" class="inp1" />
                  <button class="toggle-btn2">+</button>
                  <button id="resetPrintingBtn">Reset</button>
                </div>
                <div class="section2" id="mycontrols">
                  <label class="head2">Farms : </label
                  ><input type="number" id="field12" class="inp1" />
                  <label class="head2">Impression : </label
                  ><input type="number" id="field13" class="inp1" />
                  <label class="head2">Impression/1000 : </label
                  ><input type="number" id="field14" class="inp1" />
                </div>
              </div>
              <div class="sub-container2">
                <div id="mycontrols">
                  <label class="head2">Binding Price : </label
                  ><input type="number" id="field18" class="inp1" />
                  <button class="toggle-btn2">+</button>
                  <button id="resetBindingBtn">Reset</button>
                </div>
                <div class="section2" id="mycontrols">
                  <label class="head2">Revise Farms : </label
                  ><input type="number" id="field16" class="inp1" />
                  <label class="head2">Quantity/1000 : </label
                  ><input type="number" id="field17" class="inp1" />
                </div>
              </div>
              <div class="sub-container2">
                <div id="mycontrols">
                  <label class="head2">CTP Price : </label
                  ><input type="number" id="field21" class="inp1" />
                  <button class="toggle-btn2">+</button>
                  <button id="resetCTPbtn">Reset</button>
                </div>
                <div class="section2" id="mycontrols">
                  <label class="head2">Revise Farms : </label
                  ><input type="number" id="field19" class="inp1" />
                  <label class="head2">Plates : </label
                  ><input type="number" id="field20" class="inp1" />
                </div>
              </div>
              <div class="sub-container2">
                <div id="mycontrols">
                  <label class="head2">Title Price : </label
                  ><input type="number" id="field24" class="inp1" />
                  <button class="toggle-btn2">+</button>
                  <button id="resetTitlebtn">Reset</button>
                </div>
                <div class="section2" id="mycontrols">
                  <label class="head2">Lamination Price : </label
                  ><input
                    type="number"
                    id="field22"
                    class="inp1"
                    value="2.32"
                  />
                  <label class="head2">Without Lamination Price : </label
                  ><input
                    type="number"
                    id="field23"
                    class="inp1"
                    value="1.10"
                  />
                </div>
              </div>
              <div class="sub-container2">
                <div id="mycontrols">
                  <label class="head2">Paper Price : </label
                  ><input type="text" id="field29" class="inp1" />
                  <button class="toggle-btn2">+</button>
                  <button id="paperpriceresetbtn">Reset</button>
                </div>
                <div class="section2" id="mycontrols">
                  <label class="head2">Paper KG: </label
                  ><input
                    type="number"
                    id="field25"
                    class="inp1"
                    value="11.19"
                  />
                  <label class="head2">Farms+Quantity+400 : </label
                  ><input type="number" id="field26" class="inp1" />
                  <label class="head2">REEMS: </label
                  ><input type="number" id="field27" class="inp1" />
                  <label class="head2">Paper Weight : </label
                  ><input type="number" id="field28" class="inp1" />
                </div>
              </div>
              <div id="mycontrols">
                <label class="head2">Total Price : </label
                ><input type="number" id="field30" class="inp1" />
                <label class="head2">Unit Price : </label
                ><input type="number" id="field31" class="inp1" />
                <label class="head2">Comment : </label
                ><input type="text" id="field32" />
              </div>
            </div>
          </div>
          <div class="sub-container1">
            <label>Quotation PDF</label>
            <button class="toggle-btn1">+</button>
            <button onclick="downloadQuotationPDF()">
              üìÑ DOWNLOAD QUOTATION
            </button>
            <div class="section1">
              <label
                ><input type="checkbox" id="view1" onchange="toggleView1()" />
                View1</label
              >
              <label
                ><input type="checkbox" id="view2" onchange="toggleView2()" />
                View2</label
              >
              <div class="sub-container2">
                <div id="mycontrols">
                  <label class="head2">Fields List</label>
                  <button class="toggle-btn2">+</button>
                </div>
                <div class="section2">
                  <div class="fieldGroup">
                    <div id="checkboxContainer">
                      <label
                        ><input
                          type="checkbox"
                          id="selectAll"
                          onchange="toggleAllCheckboxes()"
                        />
                        Select All</label
                      >
                      <label
                        ><input
                          type="checkbox"
                          class="fieldCheckbox"
                          value="field7"
                        />
                        S No</label
                      >
                      <label
                        ><input
                          type="checkbox"
                          class="fieldCheckbox"
                          value="field8"
                        />
                        Book Name</label
                      >
                      <label
                        ><input
                          type="checkbox"
                          class="fieldCheckbox"
                          value="field9"
                        />
                        No of Pages</label
                      >
                      <label
                        ><input
                          type="checkbox"
                          class="fieldCheckbox"
                          value="field10"
                        />
                        Quantity</label
                      >
                      <label
                        ><input
                          type="checkbox"
                          class="fieldCheckbox"
                          value="field11"
                        />
                        Lamination</label
                      >
                      <label
                        ><input
                          type="checkbox"
                          class="fieldCheckbox"
                          value="field33"
                        />
                        Color</label
                      >
                      <label
                        ><input
                          type="checkbox"
                          class="fieldCheckbox"
                          value="field12"
                        />
                        Printing Farms</label
                      >
                      <label
                        ><input
                          type="checkbox"
                          class="fieldCheckbox"
                          value="field13"
                        />
                        Printing Impression</label
                      >
                      <label
                        ><input
                          type="checkbox"
                          class="fieldCheckbox"
                          value="field14"
                        />
                        Printing Impression/100</label
                      >
                      <label
                        ><input
                          type="checkbox"
                          class="fieldCheckbox"
                          value="field15"
                        />
                        Printing Price</label
                      >
                      <label
                        ><input
                          type="checkbox"
                          class="fieldCheckbox"
                          value="field16"
                        />
                        Binding Revised Farms</label
                      >
                      <label
                        ><input
                          type="checkbox"
                          class="fieldCheckbox"
                          value="field17"
                        />
                        Binding Quantity /1000</label
                      >
                      <label
                        ><input
                          type="checkbox"
                          class="fieldCheckbox"
                          value="field18"
                        />
                        Binding Price</label
                      >
                      <label
                        ><input
                          type="checkbox"
                          class="fieldCheckbox"
                          value="field19"
                        />
                        CTP Revised Farms</label
                      >
                      <label
                        ><input
                          type="checkbox"
                          class="fieldCheckbox"
                          value="field20"
                        />
                        CTP Plates</label
                      >
                      <label
                        ><input
                          type="checkbox"
                          class="fieldCheckbox"
                          value="field21"
                        />
                        CTP Price</label
                      >
                      <label
                        ><input
                          type="checkbox"
                          class="fieldCheckbox"
                          value="field22"
                        />
                        Lamination Price</label
                      >
                      <label
                        ><input
                          type="checkbox"
                          class="fieldCheckbox"
                          value="field23"
                        />
                        Without Lamination Price</label
                      >
                      <label
                        ><input
                          type="checkbox"
                          class="fieldCheckbox"
                          value="field24"
                        />
                        Title Price</label
                      >
                      <label
                        ><input
                          type="checkbox"
                          class="fieldCheckbox"
                          value="field25"
                        />
                        Paper KG</label
                      >
                      <label
                        ><input
                          type="checkbox"
                          class="fieldCheckbox"
                          value="field26"
                        />
                        Paper Farms*(Quantity + 300)</label
                      >
                      <label
                        ><input
                          type="checkbox"
                          class="fieldCheckbox"
                          value="field27"
                        />
                        REEMS</label
                      >
                      <label
                        ><input
                          type="checkbox"
                          class="fieldCheckbox"
                          value="field28"
                        />
                        Paper Weight</label
                      >
                      <label
                        ><input
                          type="checkbox"
                          class="fieldCheckbox"
                          value="field29"
                        />
                        Paper Price</label
                      >
                      <label
                        ><input
                          type="checkbox"
                          class="fieldCheckbox"
                          value="field30"
                        />
                        Total Price</label
                      >
                      <label
                        ><input
                          type="checkbox"
                          class="fieldCheckbox"
                          value="field31"
                        />
                        Unit Price</label
                      >
                      <label
                        ><input
                          type="checkbox"
                          class="fieldCheckbox"
                          value="field32"
                        />
                        Comment</label
                      >
                    </div>
                  </div>
                </div>
                <div class="table-wrapper">
                  <table id="quotationDetailsTable">
                    <thead>
                      <tr id="tableHeaders"></tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="page" id="page-taxinvoices">
        <!-- Tax Invoices Page HTML -->
        <div class="Main-container">
          <div class="sub-container1">
            <label>TAX INVOICES</label>
            <label for="invoiceDropdown">Select Existing Invoice:</label>
            <select id="invoiceDropdown" onchange="loadInvoiceData()">
              <option value="">-- Select Invoice --</option>
            </select>
            <button class="toggle-btn1">+</button>
            <div class="section1">
              <label for="invoiceDate">Invoice Date:</label>
              <input type="date" id="invoiceDate" />
              <label for="invoiceNumber">Auto Invoice Number:</label>
              <input type="text" id="invoiceNumber" readonly />
              <label for="PdfInvoiceNumber">PDF Invoice Number :</label>
              <input
                type="text"
                id="PdfInvoiceNumber"
                placeholder="PDF Invoice Number"
              />
              <label for="CustomerAddressDropdown">Customer Address :</label>
              <select id="CustomerAddressDropdown" class="drp" onchange="">
                <option value="">-- Customer Address --</option>
              </select>
              <label for="ShippingAddressDropdown">Shipping Address :</label>
              <select id="ShippingAddressDropdown" class="drp" onchange="">
                <option value="">-- Shipping Address --</option>
              </select>
              <label
                >Vehical Number :
                <input
                  type="text"
                  id="vehicalNumber"
                  value=""
                  placeholder="Vehicle Number"
              /></label>
              <label
                >Place of Supply :
                <input
                  type="text"
                  id="placeOfSupply"
                  value=""
                  placeholder="Place of supply"
              /></label>
              <label
                >Date and Time :
                <input
                  type="text"
                  id="dateAndTime"
                  value=""
                  placeholder="Date and Time"
              /></label>

              <button id="createTaxInvoiceBtn">Create Invoice</button>
              <button onclick="updateTaxInvoice()">Update Invoice</button>
              <button onclick="deleteTaxInvoice()">Delete Invoice</button>
              <button onclick="clearInvoiceForm()">üßπ</button>
            </div>
          </div>
          <div class="sub-container1">
            <label>NEW ADDRESS</label>
            <select
              id="AddressDropdownMain"
              class="drp"
              onchange="handleAddressSelectionMain()"
            >
              <option value="">-- Select Address --</option>
            </select>
            <button class="toggle-btn1">+</button>
            <div class="section1">
              <label
                ><input
                  type="text"
                  id="InvoiceCustomerName"
                  value=""
                  placeholder="Customer Name"
              /></label>
              <label
                ><input
                  type="text"
                  id="Address1"
                  value=""
                  placeholder="Address 1"
              /></label>
              <label
                ><input
                  type="text"
                  id="Address2"
                  value=""
                  placeholder="Address 2"
              /></label>
              <label
                ><input
                  type="text"
                  id="Address3"
                  value=""
                  placeholder="Address 3"
              /></label>
              <button class="btn" onclick="deleteAddressMain()">
                üóëÔ∏è Delete
              </button>
              <button
                class="btn"
                id="createAddressBtn"
                onclick="createNewAddress()"
              >
                ‚ûï New
              </button>
              <button class="btn" onclick="updateAddressMain() ">
                ‚úèÔ∏è Update
              </button>
            </div>
          </div>

          <div class="sub-container1">
            <label>GOODS ENTRIES</label>
            <button class="toggle-btn1">+</button>
            <div class="section1">
              <div id="mycontrols">
                <button id="prevInvoiceBtn">¬´</button>
                <span id="invoiCerecordCount">Record 1 of X</span>
                <button id="nextInvoiceBtn">¬ª</button>
                <button onclick="addInvoiceBookEntry()">‚ûï</button>
                <button onclick="updateInvoiceBookEntry()">‚úèÔ∏è</button>
                <button onclick="deleteInvoiceBookEntry()">üóëÔ∏è</button>
              </div>
              <div id="mycontrols">
                <label class="head2"
                  >Description :
                  <input type="text" id="gooddesc" class="inp1" value=""
                /></label>
                <label class="head2"
                  >HSN/SAC Code :
                  <input type="number" id="goodhsn" class="inp1" value=""
                /></label>
                <label class="head2"
                  >GST :
                  <input type="number" id="goodgst" class="inp1" value="5"
                /></label>
                <label class="head2"
                  >Unit Price :
                  <input type="number" id="goodprice" class="inp1" value=""
                /></label>
                <label class="head2"
                  >Quantity :
                  <input type="number" id="goodqty" class="inp1" value=""
                /></label>
                <label class="head2"
                  >Total Price :
                  <input type="number" id="goodtotal" class="inp1" value=""
                /></label>
              </div>
            </div>
          </div>
          <div class="sub-container1">
            <label>INVOICE PDF</label>
            <button class="toggle-btn1">+</button>
            <button onclick="PrintInvoice()" class="btn">Print Invoice</button>
            <div class="section1">
              <div class="table-container">
                <table id="InvoiceTable">
                  <!-- Header -->
                  <tr>
                    <td colspan="2" style="font-size: 13px; padding: 10px">
                      TAX INVOICE
                    </td>
                  </tr>
                  <tr>
                    <td colspan="2" style="font-size: 28px; padding: 10px">
                      M/s. MAK PRINTERS
                    </td>
                  </tr>
                  <tr>
                    <td
                      colspan="2"
                      style="font-size: 14px; padding: 5px; font-weight: bold"
                    >
                      Flat No : Survey No 216 To 222, Cherlapally Main Road,
                      Medchal Malkajgiri, Hyderabad, Telangana 500051
                    </td>
                  </tr>
                  <tr>
                    <td
                      colspan="2"
                      style="font-size: 14px; padding: 5px; font-weight: bold"
                    >
                      Email: mohammadabdulkareem89@gmail.com
                    </td>
                  </tr>
                  <tr>
                    <td
                      colspan="2"
                      style="font-size: 14px; padding: 5px; font-weight: bold"
                    >
                      GST NO: 36ACCFM8365N1ZK
                    </td>
                  </tr>
                  <!-- Supplier & Transport -->
                  <tr>
                    <td
                      style="width: 50%; padding: 0px; border: 1px solid #000"
                    >
                      <table
                        class="sub-table"
                        style="
                          width: 100%;
                          padding: 0px;
                          border: 0px solid #000;
                        "
                      >
                        <tr>
                          <td><strong>Supplier Details</strong></td>
                        </tr>
                        <tr>
                          <td id="invoiceCellDate">DATE:</td>
                        </tr>
                        <tr>
                          <td id="invoiceCell">INVOICE NO:</td>
                        </tr>
                        <tr>
                          <td>GSTIN: 36ACCFM8365N1ZK</td>
                        </tr>
                      </table>
                    </td>
                    <td style="width: 50%; padding: 0px">
                      <table
                        class="sub-table"
                        style="
                          width: 100%;
                          padding: 0px;
                          border: 0px solid #000;
                        "
                      >
                        <tr>
                          <td><strong>Transportation Mode:</strong></td>
                        </tr>
                        <tr>
                          <td id="vehicalno">Vehicle No:</td>
                        </tr>
                        <tr>
                          <td id="datesupply">Date & Time of Supply:</td>
                        </tr>
                        <tr>
                          <td id="placesupply">Place of Supply:</td>
                        </tr>
                      </table>
                    </td>
                  </tr>

                  <!-- Customer & Shipping -->
                  <tr>
                    <td
                      style="
                        width: 50%;
                        padding: 0px;
                        border-width: 0px 1px 0px 1px;
                        border-style: solid;
                        border-color: #000;
                      "
                    >
                      <table
                        class="sub-table"
                        style="
                          width: 100%;
                          padding: 0px;
                          border: 0px solid #000;
                        "
                      >
                        <tr>
                          <td><strong>Customer Details</strong></td>
                        </tr>
                        <tr>
                          <td id="invoicecustomername">Customer Name</td>
                        </tr>
                        <tr>
                          <td id="invoiceaddress1">Address1</td>
                        </tr>
                        <tr>
                          <td id="invoiceaddress2">Address2</td>
                        </tr>
                        <tr>
                          <td id="invoiceaddress3">Address3</td>
                        </tr>
                      </table>
                    </td>
                    <td
                      style="
                        width: 50%;
                        padding: 0px;
                        border-width: 0px 1px 0px 0px;
                        border-style: solid;
                        border-color: #000;
                      "
                    >
                      <table
                        class="sub-table"
                        style="width: 100%; padding: 0px"
                      >
                        <tr>
                          <td>
                            <strong>Details of Consignee (Shipping to)</strong>
                          </td>
                        </tr>
                        <tr>
                          <td id="shippingcustomer">&nbsp;</td>
                        </tr>
                        <tr>
                          <td id="shippingAddress1">&nbsp;</td>
                        </tr>
                        <tr>
                          <td id="shippingAddress2">&nbsp;</td>
                        </tr>
                        <tr>
                          <td id="shippingAddress3">&nbsp;</td>
                        </tr>
                      </table>
                    </td>
                  </tr>

                  <!-- Inventory Table -->
                  <tr>
                    <td
                      colspan="2"
                      style="
                        padding: 0px;
                        border-width: 0px 0px 0px 0px;
                        border-style: solid;
                        border-color: #000;
                      "
                    >
                      <table id="booksinventory">
                        <thead style="padding: 0px">
                          <tr>
                            <th>S.NO</th>
                            <th>DESCRIPTION OF BOOK</th>
                            <th>HSN/SAC CODE</th>
                            <th>GST</th>
                            <th>QTY.</th>
                            <th>Total</th>
                          </tr>
                        </thead>
                        <tbody id="booksBody">
                          <!-- Dynamic rows go here -->
                        </tbody>
                      </table>
                    </td>
                  </tr>

                  <!-- Net Amount -->
                  <tr>
                    <td
                      style="
                        width: 50%;
                        vertical-align: center;
                        font-weight: bold;
                        border-width: 0px 1px 0px 1px;
                        border-style: solid;
                        border-color: #000;
                      "
                    >
                      NET AMOUNT
                    </td>
                    <td
                      id="Totalamount"
                      style="
                        width: 50%;
                        text-align: right;
                        padding-right: 50px;
                        border-width: 0px 1px 0px 0px;
                        border-style: solid;
                        border-color: #000;
                      "
                    >
                      0.00
                    </td>
                  </tr>

                  <!-- Tax & Totals -->
                  <tr>
                    <td
                      colspan="2"
                      style="
                        padding: 0px;
                        border-width: 0px 0px 0px 0px;
                        border-style: solid;
                        border-color: #000;
                      "
                    >
                      <table style="width: 100%; border-collapse: collapse">
                        <tr>
                          <th
                            id="grossTotalWords"
                            rowspan="5"
                            style="
                              width: 50%;
                              text-align: left;
                              font-size: 13px;
                              padding: 5px;
                            "
                          >
                            Amount In Words
                          </th>
                          <td style="text-align: left">Output IGST 5%</td>
                          <td id="TotalGST">0.00</td>
                        </tr>
                        <tr>
                          <td style="text-align: left">
                            <strong>Total Amount</strong>
                          </td>
                          <td id="Totalamount1">0.00</td>
                        </tr>
                        <tr>
                          <td style="text-align: left">Freight Charges</td>
                          <td>0.00</td>
                        </tr>
                        <tr>
                          <td style="text-align: left">
                            Other Charges / Round off
                          </td>
                          <td>0.00</td>
                        </tr>
                        <tr>
                          <td style="text-align: left">
                            <strong>GROSS TOTAL</strong>
                          </td>
                          <td id="grossTotal">0.00</td>
                        </tr>
                      </table>
                    </td>
                  </tr>

                  <!-- Declaration & Bank Details -->
                  <tr>
                    <td
                      colspan="2"
                      style="
                        padding: 0px;
                        border-width: 0px 0px 0px 0px;
                        border-style: solid;
                        border-color: #000;
                      "
                    >
                      <table
                        style="
                          width: 100%;
                          border-collapse: collapse;
                          border-width: 0px 1px 0px 0px;
                          border-style: solid;
                          border-color: #000;
                          text-align: left;
                        "
                      >
                        <tr>
                          <td
                            rowspan="6"
                            style="
                              width: 50%;
                              font-size: 13px;
                              text-align: left;
                              padding: 5px;
                              border-width: 0px 1px 1px 1px;
                              border-style: solid;
                              border-color: #000;
                              vertical-align: bottom;
                            "
                          >
                            <strong><u>Declaration</u></strong>
                            <p>
                              We declare that this invoice shows the actual
                              price of the goods supplied and that all
                              particulars are true and correct.
                            </p>
                          </td>
                          <td
                            colspan="2"
                            style="
                              border-width: 0px 1px 0px 0px;
                              border-style: solid;
                              border-color: #000;
                            "
                          >
                            <strong><u>Company's Bank Details</u></strong>
                          </td>
                        </tr>
                        <tr>
                          <td
                            style="
                              border-width: 0px 0px 0px 0px;
                              border-style: solid;
                              border-color: #000;
                            "
                          >
                            Bank Name
                          </td>
                          <td
                            style="
                              border-width: 0px 0px 0px 0px;
                              border-style: solid;
                              border-color: #000;
                            "
                          >
                            UNION BANK OF INDIA
                          </td>
                        </tr>
                        <tr>
                          <td
                            style="
                              border-width: 0px 0px 0px 0px;
                              border-style: solid;
                              border-color: #000;
                            "
                          >
                            A/C No
                          </td>
                          <td
                            style="
                              border-width: 0px 0px 0px 0px;
                              border-style: solid;
                              border-color: #000;
                            "
                          >
                            124911010000128
                          </td>
                        </tr>
                        <tr>
                          <td
                            style="
                              border-width: 0px 0px 0px 0px;
                              border-style: solid;
                              border-color: #000;
                            "
                          >
                            Branch
                          </td>
                          <td
                            style="
                              border-width: 0px 0px 0px 0px;
                              border-style: solid;
                              border-color: #000;
                            "
                          >
                            UNION BANK OF INDIA, CHERLAPALLY
                          </td>
                        </tr>
                        <tr>
                          <td
                            style="
                              border-width: 0px 0px 0px 0px;
                              border-style: solid;
                              border-color: #000;
                            "
                          >
                            IFS Code
                          </td>
                          <td
                            style="
                              border-width: 0px 0px 0px 0px;
                              border-style: solid;
                              border-color: #000;
                            "
                          >
                            UBINO812498
                          </td>
                        </tr>
                        <tr>
                          <td colspan="2" style="height: 90px">
                            FOR MAK PRINTERS
                          </td>
                        </tr>
                      </table>
                    </td>
                  </tr>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="page" id="page-raddi">
        <!-- Raddi Page HTML -->
        <div class="pageheader">Raddi</div>
        <div class="Main-container">
          <!-- Raddi Details -->
          <div class="sub-container1">
            <label>RADDI DETAILS</label>
            <button class="toggle-btn1">+</button>
            <select id="raddi-selector" onchange="viewRaddi()">
              <option value="">-- Select Raddi ID --</option>
            </select>
            <div class="section1">
              <input type="date" id="raddi-date" />
              <button onclick="createRaddi()">üì¶ Create Raddi</button>
              <button id="update-raddi-btn" onclick="handleUpdateRaddi()">
                üíæ Update Raddi
              </button>
              <button id="delete-raddi-btn" onclick="handleDeleteRaddi()">
                üíæ Delete Raddi
              </button>
            </div>
          </div>

          <!-- Base Template -->
          <div class="sub-container1">
            <label>Base Template</label>
            <button class="toggle-btn1">+</button>
            <div class="section1">
              <table id="base-table">
                <thead>
                  <tr>
                    <th>Category</th>
                    <th>Rate</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
              <button onclick="addBaseRow()">‚ûï Add Category</button>
            </div>
          </div>

          <!-- Raddi View -->
          <div class="sub-container1">
            <label>RADDI VIEW</label>
            <button class="toggle-btn1">+</button>
            <button onclick="handleViewedRaddiUpdate()">üíæ Update Raddi</button>
            <button onclick="handleDeleteRaddi()">üóëÔ∏è Delete Raddi</button>
            <div class="section1">
              <div id="raddi-view"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      //  ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ SIDE MENU  START ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ */

      let menuVisible = false;

      function toggleMenu() {
        const nav = document.getElementById("sideMenu");
        menuVisible = !menuVisible;
        nav.style.left = menuVisible ? "0" : "-200px";
      }

      function showPage(index) {
        const pages = document.querySelectorAll(".page");

        pages.forEach((page, i) => {
          page.classList.remove("active"); // Remove all
        });
        pages[index].classList.add("active"); // Show only one

        // Hide menu after clicking
        menuVisible = false;
        document.getElementById("sideMenu").style.left = "-200px";
      }

      document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll(".toggle-btn1").forEach((button) => {
          const section = button
            .closest(".sub-container1")
            .querySelector(".section1");
          button.addEventListener("click", () => {
            section.classList.toggle("visible");
            button.textContent = section.classList.contains("visible")
              ? "‚àí"
              : "+";
          });
        });

        document.querySelectorAll(".toggle-btn2").forEach((button) => {
          const section = button
            .closest(".sub-container2")
            .querySelector(".section2");
          button.addEventListener("click", () => {
            section.classList.toggle("visible");
            button.textContent = section.classList.contains("visible")
              ? "‚àí"
              : "+";
          });
        });
      });

      document.addEventListener("click", function (event) {
        // If menu is open and click is outside the icon
        const menu = document.getElementById("sideMenu");
        const icon = document.getElementById("menuToggle");

        if (menuVisible && !icon.contains(event.target)) {
          menu.style.left = "-200px";
          menuVisible = false;
        }
      });
    </script>

    <script>
      // ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ Quotation DataBase and Manipulations ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ
      let db;
      let suppressFilter = false;
      const DB_NAME = "QuotationDB";
      const STORE_QUOTES = "quotations";
      const STORE_DETAILS = "quotationDetails";

      window.addEventListener("load", () => {
        initDB();
        showPage(0);
      });

      function initDB() {
        const request = indexedDB.open(DB_NAME, 10);

        request.onupgradeneeded = (event) => {
          db = event.target.result;
          if (!db.objectStoreNames.contains(STORE_QUOTES)) {
            db.createObjectStore(STORE_QUOTES, { keyPath: "id" });
          }
          if (!db.objectStoreNames.contains(STORE_DETAILS)) {
            const store = db.createObjectStore(STORE_DETAILS, {
              keyPath: "recordId",
              autoIncrement: true,
            });
            store.createIndex("quotationId", "quotationId", { unique: false });
          }
        };

        request.onsuccess = () => {
          db = request.result;
          populateQuotationDropdown();
          attachFieldCheckboxListeners();
          dbReady = true;
          tryPopulateDashboard();
        };
      }

      function attachFieldCheckboxListeners() {
        document.querySelectorAll(".fieldCheckbox").forEach((cb) => {
          cb.removeEventListener("change", filterTable); // prevent duplicates
          cb.addEventListener("change", filterTable);
        });
      }

      function createNewQuotation() {
        const name = document.getElementById("customerName").value.trim();
        const manualNumber = document
          .getElementById("quotationNumber")
          .value.trim();

        if (!name) return alert("Customer name cannot be blank.");

        const txn = db.transaction(STORE_QUOTES, "readonly");
        const store = txn.objectStore(STORE_QUOTES);

        const idToUse = manualNumber || null;

        if (idToUse) {
          // Check if manual ID already exists
          const check = store.get(idToUse);
          check.onsuccess = () => {
            if (check.result) {
              alert(`Quotation number "${idToUse}" already exists.`);
            } else {
              // Safe to use manual ID
              const data = { id: idToUse, customer: name, number: idToUse };
              const writeTxn = db.transaction(STORE_QUOTES, "readwrite");
              writeTxn.objectStore(STORE_QUOTES).add(data);
              document.getElementById("quotationIdDropdown").value = idToUse;
              populateQuotationDropdown();
              console.log("‚úÖ Created with manual ID:", data);
            }
          };
        } else {
          // Auto-generate ID
          const getAll = store.getAll();
          getAll.onsuccess = () => {
            const nextNumber = getAll.result.length + 1;
            const newId = `MAK-${String(nextNumber).padStart(3, "0")}`;
            const data = { id: newId, customer: name, number: newId };

            const writeTxn = db.transaction(STORE_QUOTES, "readwrite");
            writeTxn.objectStore(STORE_QUOTES).add(data);
            document.getElementById("quotationIdDropdown").value = newId;
            document.getElementById("quotationNumber").value = newId;
            populateQuotationDropdown();
            console.log("‚úÖ Created with auto ID:", data);
          };
        }
      }

      function updateQuotation() {
        const id = document.getElementById("quotationIdDropdown").value.trim();
        const name = document.getElementById("customerName").value.trim();
        const number = document.getElementById("quotationNumber").value.trim();

        if (!id || !name) {
          alert("Quotation ID and Customer Name are required.");
          return;
        }

        const data = { id, customer: name, number };

        const txn = db.transaction(STORE_QUOTES, "readwrite");
        const store = txn.objectStore(STORE_QUOTES);
        const request = store.put(data);

        request.onsuccess = () => {
          console.log("‚úÖ Quotation updated:", data);
          populateQuotationDropdown();
          setTimeout(() => loadQuotationDetails(), 100); // ‚è≥ Ensure DB is settled
        };

        request.onerror = (event) => {
          console.error("‚ùå Update failed:", event.target.error);
          alert("Failed to update quotation.");
        };
      }

      function deleteQuotation() {
        const id = document.getElementById("quotationIdDropdown").value.trim();

        // Step 1: Delete related records from STORE_DETAILS
        const detailTxn = db.transaction(STORE_DETAILS, "readwrite");
        const detailStore = detailTxn.objectStore(STORE_DETAILS);
        const detailRequest = detailStore.openCursor();

        detailRequest.onsuccess = function (event) {
          const cursor = event.target.result;
          if (cursor) {
            const record = cursor.value;
            if (record.quotationId === id) {
              cursor.delete(); // Delete matching record
            }
            cursor.continue();
          }
        };

        detailRequest.onerror = function () {
          console.error(
            "Error deleting detail records related to quotation:",
            id
          );
        };

        // Step 2: Delete the quotation itself from STORE_QUOTES
        const quoteTxn = db.transaction(STORE_QUOTES, "readwrite");
        quoteTxn.objectStore(STORE_QUOTES).delete(id);

        quoteTxn.oncomplete = function () {
          populateQuotationDropdown();
        };
      }

      function populateQuotationDropdown() {
        const dropdown = document.getElementById("quotationIdDropdown");
        dropdown.innerHTML = "";

        // üü° Add placeholder option
        const placeholder = document.createElement("option");
        placeholder.value = "";
        placeholder.textContent = "Select Quotation";
        placeholder.disabled = true;
        placeholder.selected = true;
        dropdown.appendChild(placeholder);

        const txn = db.transaction(STORE_QUOTES, "readonly");
        const store = txn.objectStore(STORE_QUOTES);
        const getAll = store.getAll();

        getAll.onsuccess = () => {
          const quotations = getAll.result.sort((a, b) =>
            a.id.localeCompare(b.id)
          );

          quotations.forEach((q) => {
            const opt = document.createElement("option");
            opt.value = q.id;
            opt.textContent = q.id;
            dropdown.appendChild(opt);
          });
        };
      }

      document
        .getElementById("quotationIdDropdown")
        .addEventListener("change", () => {
          loadQuotationDetails();
          updateQuotationSummary();
        });

      function updateQuotationSummary() {
        const id = document.getElementById("quotationIdDropdown").value;
        if (!id) return;

        const txn = db.transaction(STORE_DETAILS, "readonly");
        const store = txn.objectStore(STORE_DETAILS);
        const index = store.index("quotationId");
        const req = index.getAll(id);

        let totalBooks = 0;
        let totalQuantity = 0;
        let totalWeight = 0;
        let totalPrice = 0;

        req.onsuccess = () => {
          const seen = new Set();

          req.result.forEach((record) => {
            const uniqueKey = `${record.quotationId}-${record.field7}`;
            if (seen.has(uniqueKey)) return;
            seen.add(uniqueKey);

            totalBooks++;
            totalQuantity += Number(record.field10) || 0;
            totalWeight += Number(record.field28) || 0;
            totalPrice += Number(record.field30) || 0;
          });

          document.getElementById("totalBooks").textContent = totalBooks;
          document.getElementById("totalQuantity").textContent = totalQuantity;
          document.getElementById("totalWeight").textContent =
            totalWeight.toFixed(2);
          document.getElementById("totalPrice").textContent =
            totalPrice.toFixed(2);
        };

        req.onerror = (event) => {
          console.error("‚ùå Failed to read details:", event.target.error);
        };
      }

      function NewQuotationDetail() {
        const quotationId = document
          .getElementById("quotationIdDropdown")
          .value.trim();
        const field7El = document.getElementById("field7");
        const field7Value = field7El.value.trim();

        if (!quotationId) {
          alert("Please select a Quotation ID.");
          return;
        }
        const txn = db.transaction(STORE_DETAILS, "readonly");
        const store = txn.objectStore(STORE_DETAILS);
        const index = store.index("quotationId");
        const request = index.getAll(quotationId);

        request.onsuccess = function (event) {
          const records = event.target.result;

          // Find the highest existing S.No and increment
          const maxSno = records.reduce((max, record) => {
            const sno = parseInt(record.field7);
            return !isNaN(sno) && sno > max ? sno : max;
          }, 0);

          const newSno = maxSno + 1;
          field7El.value = newSno;

          // Clear fields except field15
          const skipFields = [1, 2, 3, 4, 5, 6, 7, 22, 23, 25];

          for (let i = 1; i <= 33; i++) {
            if (skipFields.includes(i)) continue; // Skip these fields

            const field = document.getElementById(`field${i}`);
            if (field) {
              field.value = "";
            }
          }

          // Optionally recalculate totals or refresh UI
          calculateTotal?.(); // if you have a calculateTotal function
        };

        request.onerror = function () {
          alert("Failed to fetch quotation details.");
        };
      }

      function addQuotationDetail() {
        const quotationId = document
          .getElementById("quotationIdDropdown")
          .value.trim();
        if (!quotationId) {
          alert("Please select a Quotation ID.");
          return;
        }

        const field7Value = document.getElementById("field7").value.trim();
        if (!field7Value) {
          alert("Field 7 is required.");
          return;
        }

        const txn = db.transaction(STORE_DETAILS, "readonly");
        const store = txn.objectStore(STORE_DETAILS);
        const request = store.openCursor();

        request.onsuccess = function (event) {
          const cursor = event.target.result;
          if (cursor) {
            if (
              cursor.value.quotationId === quotationId &&
              cursor.value.field7 === field7Value
            ) {
              alert(
                "A record with this S. No already exists under this Quotation ID."
              );
              return; // Abort adding
            }
            cursor.continue();
          } else {
            // Add new record since it's unique
            const detailRecord = { quotationId };
            for (let i = 1; i <= 33; i++) {
              const field = document.getElementById(`field${i}`);
              detailRecord[`field${i}`] = field.value.trim();
            }

            const addTxn = db.transaction(STORE_DETAILS, "readwrite");
            addTxn.objectStore(STORE_DETAILS).add(detailRecord);

            // Reset fields
            for (let i = 1; i <= 33; i++) {
              document.getElementById(`field${i}`).value = "";
            }

            loadQuotationDetailsById(quotationId);
          }
        };

        request.onerror = function () {
          console.error("Error checking uniqueness.");
        };
      }

      function handleQIDSelection(event) {
        // your code here
      }

      function loadQuotationDetailsById(selectedId, restoreKey = null) {
        quotationRecords = [];
        currentQuotationIndex = 0;

        const txn = db.transaction("quotationDetails", "readonly");
        const store = txn.objectStore("quotationDetails");
        const request = store.openCursor();

        request.onsuccess = function (event) {
          const cursor = event.target.result;
          if (cursor) {
            const record = cursor.value;
            if ((record.quotationId || "").trim() === selectedId) {
              quotationRecords.push(record);

              const key = `${(record.quotationId || "").trim()}__${(
                record.field7 || ""
              ).trim()}`;
              if (restoreKey && key === restoreKey) {
                currentQuotationIndex = quotationRecords.length - 1;
              }
            }
            cursor.continue();
          } else {
            if (quotationRecords.length === 0) {
              alert(`No records found for Quotation ID: ${selectedId}`);
            } else {
              showQuotationRecord(currentQuotationIndex); // ‚úÖ Show correct record
            }
          }
        };

        request.onerror = function () {
          console.error("‚ùå Failed to load quotation details.");
          alert("Error loading records.");
        };
      }

      function updateQuotationDetail() {
        const quotationId = document
          .getElementById("quotationIdDropdown")
          .value.trim();
        const field7Value = document.getElementById("field7").value.trim();

        if (!quotationId || !field7Value) {
          alert("Quotation ID and Field 7 are required.");
          return;
        }

        const restoreKey = `${quotationId}__${field7Value}`;

        const txn = db.transaction("quotationDetails", "readwrite");
        const store = txn.objectStore("quotationDetails");
        const request = store.openCursor();

        request.onsuccess = function (event) {
          const cursor = event.target.result;
          if (cursor) {
            const record = cursor.value;
            const matchId = (record.quotationId || "").trim();
            const matchField7 = (record.field7 || "").trim();

            if (matchId === quotationId && matchField7 === field7Value) {
              // Update all fields
              for (let i = 1; i <= 33; i++) {
                const input = document.getElementById(`field${i}`);
                record[`field${i}`] = input?.value?.trim() || "";
              }

              record.quotationId = quotationId;

              const updateRequest = cursor.update(record);
              updateRequest.onsuccess = function () {
                alert("‚úî Record updated successfully.");
                loadQuotationDetailsById(quotationId, restoreKey); // ‚úÖ Restore view
                updateQuotationSummary();
              };
              updateRequest.onerror = function () {
                console.error("‚ùå Error updating record.");
                alert("Failed to update record.");
              };

              return;
            }

            cursor.continue();
          } else {
            alert("No matching record found to update.");
          }
        };

        request.onerror = function () {
          console.error("‚ùå Cursor failed to open.");
          alert("Error accessing records.");
        };
      }

      function deleteDetailByQuotationAndField7(quotationId, field7Value) {
        const txn = db.transaction(STORE_DETAILS, "readwrite");
        const store = txn.objectStore(STORE_DETAILS);
        const request = store.openCursor();

        request.onsuccess = function (event) {
          const cursor = event.target.result;
          if (cursor) {
            const record = cursor.value;
            const recordQuotationId =
              typeof record.quotationId === "string"
                ? record.quotationId.trim()
                : "";
            const recordField7 =
              typeof record.field7 === "string" ? record.field7.trim() : "";
            if (
              recordQuotationId === quotationId.trim() &&
              recordField7 === field7Value.trim()
            ) {
              cursor.delete();
              console.log("Deleted record with field7:", record.field7);
              return; // Exit early since no need to continue
            }
            cursor.continue(); // No match, keep scanning
          } else {
            console.log("No more records.");
          }
        };
        request.onerror = function () {
          console.error("Deletion error.");
        };
        loadQuotationDetailsById(quotationId);
      }

      function filterTable() {
        const id = document.getElementById("quotationIdDropdown").value;
        const selectedFields = Array.from(
          document.querySelectorAll(".fieldCheckbox")
        )
          .filter((cb) => cb.checked)
          .map((cb) => cb.value);

        const tableHeader = document.getElementById("tableHeaders");
        const tableBody = document.querySelector(
          "#quotationDetailsTable tbody"
        );

        tableHeader.innerHTML = "";
        tableBody.innerHTML = "";

        // Create headers
        selectedFields.forEach((field) => {
          const label = document
            .querySelector(`input[value="${field}"]`)
            .parentElement.textContent.trim();
          const th = document.createElement("th");
          th.textContent = label;
          tableHeader.appendChild(th);
        });

        const txn = db.transaction(STORE_DETAILS, "readonly");
        const store = txn.objectStore(STORE_DETAILS);
        const index = store.index("quotationId");
        const req = index.getAll(id);

        req.onsuccess = () => {
          const seen = new Set();
          const totals = {};

          // ‚úÖ Filter unique records
          const filteredRecords = req.result.filter((record) => {
            const uniqueKey = `${record.quotationId}-${record.field7}`;
            if (seen.has(uniqueKey)) return false;
            seen.add(uniqueKey);
            return true;
          });

          // ‚úÖ Sort by field7 (S.No) ascending
          filteredRecords.sort((a, b) => {
            const valA = parseFloat(a.field7) || 0;
            const valB = parseFloat(b.field7) || 0;
            return valA - valB;
          });

          // ‚úÖ Render sorted rows
          filteredRecords.forEach((record) => {
            const tr = document.createElement("tr");

            selectedFields.forEach((field) => {
              const td = document.createElement("td");
              const value = record[field] || "";

              td.textContent = value;
              tr.appendChild(td);

              if (/^-?\d+(\.\d+)?$/.test(value.trim())) {
                const num = parseFloat(value);
                totals[field] = (totals[field] || 0) + num;
              }
            });

            tableBody.appendChild(tr);
          });

          // ‚úÖ Add total row
          const totalRow = document.createElement("tr");
          selectedFields.forEach((field, index) => {
            const td = document.createElement("td");
            td.style.fontWeight = "bold";
            td.style.backgroundColor = "#f0f0f0";

            if (index === 0) {
              td.textContent = "Total";
            } else if (totals.hasOwnProperty(field)) {
              td.textContent = totals[field].toFixed(2);
            } else {
              td.textContent = "";
            }

            totalRow.appendChild(td);
          });

          tableBody.appendChild(totalRow);
        };
      }

      document
        .getElementById("quotationIdDropdown")
        .addEventListener("change", function () {
          const selectedId = this.value;
          if (selectedId) {
            loadQuotationDetailsById(selectedId);
            updateQuotationSummary();
          }
        });

      function showQuotationRecord(index) {
        if (quotationRecords.length === 0) return;

        const record = quotationRecords[index];

        // Loop through all fields in the record
        Object.keys(record).forEach((key) => {
          const input = document.getElementById(key);
          if (input) {
            input.value = record[key] || "";
          }
        });

        document.getElementById("recordCount").textContent = `Record ${
          index + 1
        } of ${quotationRecords.length}`;
      }

      document.getElementById("nextBtn").addEventListener("click", () => {
        if (currentQuotationIndex < quotationRecords.length - 1) {
          currentQuotationIndex++;
          showQuotationRecord(currentQuotationIndex);
        }
      });

      document.getElementById("prevBtn").addEventListener("click", () => {
        if (currentQuotationIndex > 0) {
          currentQuotationIndex--;
          showQuotationRecord(currentQuotationIndex);
        }
      });

      function toggleAllCheckboxes() {
        const checked = document.getElementById("selectAll").checked;
        document
          .querySelectorAll(".fieldCheckbox")
          .forEach((cb) => (cb.checked = checked));
        filterTable();
      }

      function toggleView1() {
        const checked = document.getElementById("view1").checked;
        const fieldsToCheck = [
          "field7",
          "field8",
          "field9",
          "field10",
          "field28",
          "field30",
        ];

        // Temporarily remove listeners
        document.querySelectorAll(".fieldCheckbox").forEach((cb) => {
          cb.removeEventListener("change", filterTable);
          cb.checked = fieldsToCheck.includes(cb.value) && checked;
        });

        // Reattach listeners
        attachFieldCheckboxListeners();

        // Run filterTable once manually
        filterTable();
      }

      async function downloadQuotationPDF() {
        const tableElement = document.getElementById("quotationDetailsTable");
        if (!tableElement) {
          alert("Quotation table not found.");
          return;
        }

        const canvas = await html2canvas(tableElement, {
          scale: 2,
          useCORS: true,
        });

        const imgData = canvas.toDataURL("image/png");
        const pdf = new jspdf.jsPDF("p", "mm", "a4");

        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();

        const imgProps = pdf.getImageProperties(imgData);
        const imgWidth = pageWidth - 28; // ‚¨ÖÔ∏è 14mm margin on each side
        const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

        // üßë‚Äçüíº Header
        const custName =
          document.getElementById("customerName")?.value.trim() || "‚Äî";
        const quotationId =
          document.getElementById("quotationIdDropdown")?.value.trim() ||
          "Quotation";
        const today = new Date().toLocaleDateString();

        pdf.setFont("helvetica", "bold");
        pdf.setFontSize(18);
        pdf.setTextColor(40, 40, 40);
        pdf.text("MAK PRINTERS", pageWidth / 2, 20, { align: "center" });

        pdf.setFont("helvetica", "normal");
        pdf.setFontSize(11);
        pdf.setTextColor(70, 70, 70);
        pdf.text(`Customer Name: ${custName}`, 14, 30);
        pdf.text(`Quotation Date: ${today}`, 14, 38);
        pdf.text(`Quotation ID: ${quotationId}`, 14, 46);

        // üßæ Table Image with margins
        const contentY = 55;
        const availableHeight = pageHeight - contentY - 30;

        if (imgHeight > availableHeight) {
          pdf.addImage(imgData, "PNG", 14, contentY, imgWidth, availableHeight); // ‚¨ÖÔ∏è 14mm left margin
        } else {
          pdf.addImage(imgData, "PNG", 14, contentY, imgWidth, imgHeight); // ‚¨ÖÔ∏è 14mm left margin
        }

        // üôè Footer
        pdf.setFont("helvetica", "italic");
        pdf.setFontSize(10);
        pdf.setTextColor(100, 100, 100);
        pdf.text(
          "Thank you for choosing MAK Printers!",
          pageWidth / 2,
          pageHeight - 15,
          { align: "center" }
        );

        // üíæ Save
        pdf.save(`Quotation_${quotationId}_${custName}.pdf`);
      }

      function toggleView2() {
        document.getElementById("selectAll").checked = false;
        document
          .querySelectorAll(".fieldCheckbox")
          .forEach((cb) => (cb.checked = false));

        const checked = document.getElementById("view2").checked;
        const fieldsToCheck = [
          "field7",
          "field8",
          "field9",
          "field10",
          "field15",
          "field18",
          "field21",
          "field24",
          "field30",
          "field31",
        ];

        document.querySelectorAll(".fieldCheckbox").forEach((cb) => {
          cb.checked = fieldsToCheck.includes(cb.value) && checked;
        });

        filterTable();
      }
    </script>

    <script>
      // ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ BOOK CALCUATIONS ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ

      let lastManualChangePages = null;
      let lastManualChangeBinding = null;
      let lastManualChangeTitle = null;
      let lastManualChangeCTP = null;
      let lastManualChangePaper = null;
      let initialValues = {};

      function calculateTotal() {
        calculatePages();
        calculateBinding();
        calculateTitle();
        calculateCTP();
        calculatePaperPrice();
        calculateSummary();
      }

      function calculatePages() {
        const cal_pages =
          parseFloat(document.getElementById("field9").value) || 0;
        const cal_pageQuantity =
          parseFloat(document.getElementById("field10").value) || 1;
        const cal_color = document
          .getElementById("field33")
          .value.trim()
          .toUpperCase();

        const field2 = parseFloat(document.getElementById("field2").value) || 0;
        const field3 = parseFloat(document.getElementById("field3").value) || 0;
        const field4 = parseFloat(document.getElementById("field4").value) || 0;

        const colorMultiplier =
          cal_color === "SC"
            ? field2
            : cal_color === "DC"
            ? field3
            : cal_color === "MC"
            ? field4
            : 0;

        const field12El = document.getElementById("field12");
        const field13El = document.getElementById("field13");
        const field14El = document.getElementById("field14");
        const field15El = document.getElementById("field15");

        let field12, field13, field14;

        switch (lastManualChangePages) {
          case "field12":
            field12 = parseFloat(field12El.value) || 0;
            field13 = field12 * cal_pageQuantity;
            field14 = field13 / 1000;
            break;

          case "field13":
            field13 = parseFloat(field13El.value) || 0;
            field12 = cal_pageQuantity ? field13 / cal_pageQuantity : 0;
            field14 = field13 / 1000;
            break;

          case "field14":
            field14 = parseFloat(field14El.value) || 0;
            field13 = field14 * 1000;
            field12 = cal_pageQuantity ? field13 / cal_pageQuantity : 0;
            break;

          default:
            field12 = cal_pages / 16;
            field13 = field12 * cal_pageQuantity;
            field14 = field13 / 1000;
            field15 = (field14 * colorMultiplier).toFixed(2);
            break;
        }

        field12El.value = field12.toFixed(2);
        field13El.value = field13.toFixed(2);
        field14El.value = field14.toFixed(2);
        field15El.value = (field14 * colorMultiplier).toFixed(2);
      }

      function calculateBinding() {
        const cal_pages =
          parseFloat(document.getElementById("field9").value) || 0;
        const cal_pageQuantity =
          parseFloat(document.getElementById("field10").value) || 0;
        const cal_bindingprice =
          parseFloat(document.getElementById("field1").value) || 0;

        const field16El = document.getElementById("field16");
        const field17El = document.getElementById("field17");
        const field18El = document.getElementById("field18");

        let factor = cal_pageQuantity / 1000;
        let revisedFrames = cal_pages / 16;
        const integerPart = Math.floor(revisedFrames);
        const decimalPart = revisedFrames - integerPart;

        if (decimalPart > 0) {
          if (decimalPart <= 0.5) revisedFrames = integerPart + 2;
          else if (decimalPart > 0.6) revisedFrames = integerPart + 4;
        }

        if (
          ["field1", "field16", "field17"].includes(lastManualChangeBinding)
        ) {
          const val16 = parseFloat(field16El.value) || 0;
          const val17 = parseFloat(field17El.value) || 0;
          field18El.value = (val16 * val17 * cal_bindingprice).toFixed(2);
        } else {
          field16El.value = revisedFrames.toFixed(2);
          field17El.value = factor.toFixed(2);
          field18El.value = (revisedFrames * factor * cal_bindingprice).toFixed(
            2
          );
        }
      }

      function calculateTitle() {
        const quantity =
          parseFloat(document.getElementById("field10").value) || 0;
        const laminationType = document
          .getElementById("field11")
          .value.trim()
          .toLowerCase();
        const laminationPrice =
          parseFloat(document.getElementById("field22").value) || 0;
        const withoutLaminationPrice =
          parseFloat(document.getElementById("field23").value) || 0;
        const resultEl = document.getElementById("field24");

        const price =
          laminationType === "lamination"
            ? laminationPrice
            : withoutLaminationPrice;
        const total = quantity * price;

        resultEl.value = total.toFixed(2);
        calculateSummary();
      }

      function calculateCTP() {
        const cal_pages =
          parseFloat(document.getElementById("field9").value) || 0;
        const cal_color = document
          .getElementById("field33")
          .value.trim()
          .toUpperCase();
        const cal_ctpprice =
          parseFloat(document.getElementById("field5").value) || 0;

        const field19El = document.getElementById("field19");
        const field20El = document.getElementById("field20");
        const field21El = document.getElementById("field21");

        const colorMultiplier =
          cal_color === "DC"
            ? 4
            : cal_color === "SC"
            ? 2
            : cal_color === "MC"
            ? 8
            : 1;

        function calculateBaseValue(pages) {
          let baseValue = Math.floor(pages / 16);
          const remainder = pages % 16;
          if (remainder === 4 || remainder === 8) baseValue += 1;
          else if (remainder > 8) baseValue += 2;
          return baseValue;
        }

        let baseValue = calculateBaseValue(cal_pages);

        if (["field19", "field20"].includes(lastManualChangeCTP)) {
          const val19 = parseFloat(field19El.value) || 0;
          const val20 = parseFloat(field20El.value) || 0;
          field21El.value = (val19 * val20 * cal_ctpprice).toFixed(2);
        } else {
          field19El.value = baseValue;
          field20El.value = baseValue * colorMultiplier;
          field21El.value = (
            baseValue *
            colorMultiplier *
            cal_ctpprice
          ).toFixed(2);
        }
      }

      function calculatePaperPrice() {
        const cal_pages =
          parseFloat(document.getElementById("field9").value) || 0;
        const cal_pageQuantity =
          parseFloat(document.getElementById("field10").value) || 0;
        const field25 =
          parseFloat(document.getElementById("field25").value) || 0;
        const field6 = parseFloat(document.getElementById("field6").value) || 0;

        const field26El = document.getElementById("field26");
        const field27El = document.getElementById("field27");
        const field28El = document.getElementById("field28");
        const field29El = document.getElementById("field29");

        let field26 = (cal_pages / 16) * (cal_pageQuantity + 400);
        let field27 = field26 / 500;
        let field28 = field27 * field25;
        let field29 = field28 * field6;

        if (
          [
            "field25",
            "field26",
            "field27",
            "field28",
            "field29",
            "field6",
          ].includes(lastManualChangePaper)
        ) {
          field26 = parseFloat(field26El.value) || field26;
          field27 = parseFloat(field27El.value) || field26 / 500;
          field28 = parseFloat(field28El.value) || field27 * field25;
          field29 = parseFloat(field29El.value) || field28 * field6;
        }

        field26El.value = field26.toFixed(2);
        field27El.value = field27.toFixed(2);
        field28El.value = field28.toFixed(2);
        field29El.value = field29.toFixed(2);
      }

      function calculateSummary() {
        const field15 =
          parseFloat(document.getElementById("field15").value) || 0;
        const field18 =
          parseFloat(document.getElementById("field18").value) || 0;
        const field21 =
          parseFloat(document.getElementById("field21").value) || 0;
        const field24 =
          parseFloat(document.getElementById("field24").value) || 0;
        const cal_pageQuantity =
          parseFloat(document.getElementById("field10").value) || 1;

        const field30El = document.getElementById("field30");
        const field31El = document.getElementById("field31");

        const total = field15 + field18 + field21 + field24;
        field30El.value = total.toFixed(2);
        field31El.value = (total / cal_pageQuantity).toFixed(2);
      }

      window.addEventListener("DOMContentLoaded", () => {
        initialValues = {
          quantity: document.getElementById("field10").value,
          laminationType: document.getElementById("field11").value,
          laminationPrice: document.getElementById("field22").value,
          withoutLaminationPrice: document.getElementById("field23").value,
        };

        calculateTitle(); // Initial calculation
      });
      // üñä Manual override triggers
      ["field12", "field13", "field14"].forEach((id) => {
        document.getElementById(id).addEventListener("input", () => {
          lastManualChangePages = id;
          calculateTotal();
          calculatePages();
        });
      });
      ["field1", "field16", "field17"].forEach((id) => {
        document.getElementById(id).addEventListener("input", () => {
          lastManualChangeBinding = id;
          calculateTotal();
        });
      });
      ["field19", "field20"].forEach((id) => {
        document.getElementById(id).addEventListener("input", () => {
          lastManualChangeCTP = id;
          calculateTotal();
        });
      });
      ["field25", "field26", "field27", "field28", "field29", "field6"].forEach(
        (id) => {
          document.getElementById(id).addEventListener("input", () => {
            lastManualChangePaper = id;
            calculateTotal();
          });
        }
      );
      [
        "field9",
        "field10",
        "field2",
        "field3",
        "field4",
        "field5",
        "field33",
      ].forEach((id) => {
        // üîÅ Auto recalculation triggers
        document.getElementById(id).addEventListener("input", () => {
          lastManualChangePages = null;
          lastManualChangeBinding = null;
          lastManualChangeTitle = null;
          lastManualChangeCTP = null;
          lastManualChangePaper = null;
          calculateTotal();
          calculatePages();
        });
      });
      document
        .getElementById("resetPrintingBtn")
        .addEventListener("click", () => {
          // üîÑ Reset buttons
          lastManualChangePages = null;
          calculateTotal();
        });
      document
        .getElementById("resetBindingBtn")
        .addEventListener("click", () => {
          lastManualChangeBinding = null;
          calculateTotal();
        });
      document.getElementById("resetCTPbtn").addEventListener("click", () => {
        lastManualChangeCTP = null;
        calculateTotal();
      });
      ["field10", "field11", "field22", "field23"].forEach((id) => {
        // üîÅ Live updates
        document.getElementById(id).addEventListener("input", calculateTitle);
        document.getElementById(id).addEventListener("change", calculateTitle);
      });
      document.getElementById("resetTitlebtn").addEventListener("click", () => {
        // üîÑ Reset to original values
        document.getElementById("field22").value =
          initialValues.laminationPrice;
        document.getElementById("field23").value =
          initialValues.withoutLaminationPrice;
        calculateTitle();
      });
      document
        .getElementById("paperpriceresetbtn")
        .addEventListener("click", () => {
          lastManualChangePaper = null;
          calculateTotal();
        });
    </script>

    <script>
      // ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ DASHBOARD DETAILS ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ

      let dbReady = false;
      let taxdbReady = false;
      let raddiDBReady = false;

      function tryPopulateDashboard() {
        if (dbReady && taxdbReady && raddiDBReady) {
          populateDashboardQuotationSummary();
          populateDashboardInvoiceSummary();
          populateRaddiDashboard();
        }
      }

      function populateDashboardQuotationSummary() {
        const tbody = document.getElementById("dashboard_Qutation_Body");
        if (!tbody || !db) {
          console.warn("‚ùå Quotation table or DB not ready");
          return;
        }

        const txn = db.transaction("quotationDetails", "readonly");
        const store = txn.objectStore("quotationDetails");
        const request = store.getAll();

        request.onsuccess = () => {
          const records = request.result;
          if (!records.length) {
            console.warn("‚ö†Ô∏è No quotation records found.");
            return;
          }

          const summary = {};
          records.forEach((record) => {
            const qid = record.quotationId;
            if (!summary[qid]) {
              summary[qid] = {
                books: 0,
                quantity: 0,
                weight: 0,
                price: 0,
              };
            }

            summary[qid].books += 1;
            summary[qid].quantity += parseFloat(record.field10) || 0;
            summary[qid].weight += parseFloat(record.field28) || 0;
            summary[qid].price += parseFloat(record.field30) || 0;
          });

          tbody.innerHTML = "";
          Object.entries(summary).forEach(([qid, data], index) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
        <td>${index + 1}</td>
        <td>${qid}</td>
        <td>${data.books}</td>
        <td>${data.quantity.toFixed(2)}</td>
        <td>${data.weight.toFixed(2)}</td>
        <td>${data.price.toFixed(2)}</td>
      `;
            tbody.appendChild(tr);
          });

          // üî¢ Add total row
          let totalBooks = 0,
            totalQuantity = 0,
            totalWeight = 0,
            totalPrice = 0;
          Object.values(summary).forEach((data) => {
            totalBooks += data.books;
            totalQuantity += data.quantity;
            totalWeight += data.weight;
            totalPrice += data.price;
          });

          const totalTr = document.createElement("tr");
          totalTr.style.fontWeight = "bold";
          totalTr.style.backgroundColor = "#f0f0f0";
          totalTr.innerHTML = `
      <td colspan="2">Total</td>
      <td>${totalBooks}</td>
      <td>${totalQuantity.toFixed(2)}</td>
      <td>${totalWeight.toFixed(2)}</td>
      <td>${totalPrice.toFixed(2)}</td>
    `;
          tbody.appendChild(totalTr);
        };

        request.onerror = () => {
          console.error("‚ùå Failed to read quotationDetails store");
        };
      }

      function rebuildRaddiHeader(selectedCols) {
        const headerRow = document.getElementById("Raddi_Header_Row");
        headerRow.innerHTML = ""; // Clear all headers

        // Static headers
        const staticHeaders = ["S.No", "RADDI ID", "DATE"];
        staticHeaders.forEach((text) => {
          const th = document.createElement("th");
          th.textContent = text;
          headerRow.appendChild(th);
        });

        // Dynamic headers
        selectedCols.forEach((col) => {
          const th = document.createElement("th");
          th.textContent = `${col.name} (${col.type})`;
          headerRow.appendChild(th);
        });

        // Final static column
        const thTotal = document.createElement("th");
        thTotal.textContent = "TOTAL PRICE";
        headerRow.appendChild(thTotal);
      }

      function populateRaddiDashboard() {
        const tbody = document.getElementById("Raddi_Details_Body");
        tbody.innerHTML = "";

        const selectedMonth =
          document.getElementById("raddi-month-filter").value;
        const selectedYear = document.getElementById("raddi-year-filter").value;

        const selectedCols = Array.from(
          document.querySelectorAll(".raddi-col:checked")
        ).map((cb) => ({ name: cb.value, type: cb.dataset.type }));

        // ‚úÖ Rebuild header row properly
        rebuildRaddiHeader(selectedCols);

        const baseTx = raddiDB.transaction("baseTemplate", "readonly");
        const baseStore = baseTx.objectStore("baseTemplate");

        baseStore.get("schema").onsuccess = (e) => {
          const categories = e.target.result?.categories || [];

          const tx = raddiDB.transaction("raddiEntries", "readonly");
          const store = tx.objectStore("raddiEntries");

          store.getAll().onsuccess = (e) => {
            const entries = e.target.result;
            let grandTotal = 0;
            const columnTotals = {};

            const filteredEntries = entries.filter((entry) => {
              const dateStr = entry.id.replace("Raddi-", "");
              const [year, month] = dateStr.split("-");
              const matchMonth = selectedMonth ? month === selectedMonth : true;
              const matchYear = selectedYear ? year === selectedYear : true;
              return matchMonth && matchYear;
            });

            filteredEntries.forEach((entry, i) => {
              const date = entry.id.replace("Raddi-", "");
              const total = entry.categories.reduce(
                (sum, cat) => sum + cat.weight * cat.rate,
                0
              );
              grandTotal += total;

              const dynamicCells = selectedCols
                .map((col) => {
                  const match = entry.categories.find(
                    (c) => c.name === col.name
                  );
                  let value = "‚Äî";

                  if (match) {
                    value =
                      col.type === "weight"
                        ? match.weight.toFixed(2)
                        : (match.weight * match.rate).toFixed(2);

                    if (/^-?\d+(\.\d+)?$/.test(value)) {
                      const key = col.name + "_" + col.type;
                      const num = parseFloat(value);
                      columnTotals[key] = (columnTotals[key] || 0) + num;
                    }
                  }

                  return `<td>${value}</td>`;
                })
                .join("");

              const row = document.createElement("tr");
              row.innerHTML = `
          <td>${i + 1}</td>
          <td>${entry.id}</td>
          <td>${date}</td>
          ${dynamicCells}
          <td><strong>${total.toFixed(2)}</strong></td>
        `;
              tbody.appendChild(row);
            });

            // üìä Total row
            const totalRow = document.createElement("tr");
            totalRow.style.fontWeight = "bold";
            totalRow.style.backgroundColor = "#f0f0f0";

            const totalCells = selectedCols
              .map((col) => {
                const key = col.name + "_" + col.type;
                const total = columnTotals[key];
                return `<td>${!isNaN(total) ? total.toFixed(2) : ""}</td>`;
              })
              .join("");

            totalRow.innerHTML = `
        <td colspan="3">Grand Total</td>
        ${totalCells}
        <td><strong>${grandTotal.toFixed(2)}</strong></td>
      `;
            tbody.appendChild(totalRow);
          };
        };
      }

      function populateDashboardInvoiceSummary() {
        const tbody = document.getElementById("dashboard_Invoice_Body");
        if (!tbody || !taxdb) {
          console.warn("‚ùå Invoice table or DB not ready");
          return;
        }

        // Step 1: Fetch book records
        const txnBooks = taxdb.transaction("STORE_BOOKS", "readonly");
        const storeBooks = txnBooks.objectStore("STORE_BOOKS");
        const requestBooks = storeBooks.getAll();

        requestBooks.onerror = () => {
          console.error("‚ùå Failed to read STORE_BOOKS store");
        };

        requestBooks.onsuccess = () => {
          const records = requestBooks.result;
          if (!records.length) {
            console.warn("‚ö†Ô∏è No book records found.");
            return;
          }

          // Step 2: Aggregate summary by invoiceId
          const summary = {};
          records.forEach((record) => {
            const invoiceId = record.invoiceId;
            if (!invoiceId) return;

            if (!summary[invoiceId]) {
              summary[invoiceId] = {
                books: 0,
                quantity: 0,
                price: 0,
                gst: 0,
              };
            }

            const qty = parseFloat(record.goodqty) || 0;
            const base = parseFloat(record.goodtotal) || 0;
            const gstAmount = base * 0.05;
            const priceWithGST = base * 1.05;

            summary[invoiceId].books += 1;
            summary[invoiceId].quantity += qty;
            summary[invoiceId].gst += gstAmount;
            summary[invoiceId].price += priceWithGST;
          });

          // Step 3: Fetch invoice metadata
          const txnInvoices = taxdb.transaction("TaxInvoices", "readonly");
          const storeInvoices = txnInvoices.objectStore("TaxInvoices");
          const invoiceRequest = storeInvoices.getAll();

          invoiceRequest.onerror = () => {
            console.error("‚ùå Failed to read TaxInvoices store");
          };

          invoiceRequest.onsuccess = () => {
            const invoiceRecords = invoiceRequest.result;

            // Step 4: Fetch customer address records
            const txnAddress = taxdb.transaction("TaxAddress", "readonly");
            const storeAddress = txnAddress.objectStore("TaxAddress");
            const addressRequest = storeAddress.getAll();

            addressRequest.onerror = () => {
              console.error("‚ùå Failed to read TaxAddress store");
            };

            addressRequest.onsuccess = () => {
              const addressRecords = addressRequest.result;
              tbody.innerHTML = "";

              // Step 5: Render invoice rows
              Object.entries(summary).forEach(([invoiceId, data], index) => {
                const invoiceMatch = invoiceRecords.find(
                  (inv) => inv.invoiceNumber === invoiceId
                );
                const pdfNumber = invoiceMatch?.PdfInvoiceNumber || "";
                const addressId = invoiceMatch?.customerAddress || "";
                const addressMatch = addressRecords.find(
                  (addr) => addr.id === addressId
                );
                const customerName = addressMatch?.InvoiceCustomerName || "‚Äî";

                const rawDate = invoiceMatch?.invoiceDate;
                const formattedDate = rawDate
                  ? new Date(rawDate).toLocaleDateString("en-IN")
                  : "‚Äî";

                const tr = document.createElement("tr");
                tr.innerHTML = `
            <td>${index + 1}</td>
            <td>${invoiceId}</td>
            <td>${pdfNumber}</td>
            <td>${customerName}</td>
            <td>${formattedDate}</td>
            <td>${data.books}</td>
            <td>${data.quantity.toFixed(2)}</td>
            <td>${data.gst.toFixed(2)}</td>
            <td>${data.price.toFixed(2)}</td>
          `;
                tbody.appendChild(tr);
              });

              // Step 6: Render total row
              let totalBooks = 0,
                totalQuantity = 0,
                totalGST = 0,
                totalPrice = 0;
              Object.values(summary).forEach((data) => {
                totalBooks += data.books;
                totalQuantity += data.quantity;
                totalGST += data.gst;
                totalPrice += data.price;
              });

              const totalTr = document.createElement("tr");
              totalTr.style.fontWeight = "bold";
              totalTr.style.backgroundColor = "#f0f0f0";
              totalTr.innerHTML = `
          <td colspan="5">Total</td>
          <td>${totalBooks}</td>
          <td>${totalQuantity.toFixed(2)}</td>
          <td>${totalGST.toFixed(2)}</td>
          <td>${totalPrice.toFixed(2)}</td>
        `;
              tbody.appendChild(totalTr);
            };
          };
        };
      }
    </script>

    <script>
      // ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ TAX INVOICE DATA BASE AND MANIPULATIONS ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ

      let taxdb;
      let invoiceBookEntries = [];
      let currentIndex = 0;
      let currentInvoiceBookId = null;
      const taxdb_NAME = "TaxInvoicetaxdb";
      const taxdb_VERSION = 3;
      const STORE_INVOICES = "TaxInvoices";
      const STORE_ADDRESS = "TaxAddress";
      const STORE_BOOKS = "TaxBooks";

      function initInvoicetaxdb() {
        const request = indexedDB.open(taxdb_NAME, taxdb_VERSION);
        request.onupgradeneeded = function (event) {
          taxdb = event.target.result;
          if (!taxdb.objectStoreNames.contains(STORE_INVOICES)) {
            const quoteStore = taxdb.createObjectStore(STORE_INVOICES, {
              keyPath: "id",
            });
            quoteStore.createIndex("invoiceNumber", "invoiceNumber", {
              unique: true,
            });
          }
          if (!taxdb.objectStoreNames.contains(STORE_ADDRESS)) {
            const addressStore = taxdb.createObjectStore(STORE_ADDRESS, {
              keyPath: "id",
              autoIncrement: true,
            });
            addressStore.createIndex(
              "InvoiceCustomerName",
              "InvoiceCustomerName",
              { unique: false }
            );
          }
          if (!taxdb.objectStoreNames.contains("STORE_BOOKS")) {
            const bookStore = taxdb.createObjectStore("STORE_BOOKS", {
              keyPath: "id",
            });
            bookStore.createIndex("invoiceId", "invoiceId", { unique: false });
          }
        };

        request.onsuccess = function (event) {
          taxdb = event.target.result;
          console.log("‚úÖ Database initialized");
          populateTaxInvoiceDropdown();
          loadAddressDropdownMain();
          taxdbReady = true;
          tryPopulateDashboard();
        };
        request.onerror = function (event) {
          console.error("Database error:", event.target.errorCode);
        };
      }

      function generateTaxInvoiceId(selectedDateStr, callback) {
        const selectedDate = new Date(selectedDateStr);
        const dateStr = `${String(selectedDate.getMonth() + 1).padStart(
          2,
          "0"
        )}${String(selectedDate.getDate()).padStart(2, "0")}${String(
          selectedDate.getFullYear()
        ).slice(-2)}`;

        const transaction = taxdb.transaction(STORE_INVOICES, "readonly");
        const store = transaction.objectStore(STORE_INVOICES);
        const request = store.getAll();

        request.onsuccess = function () {
          const count = request.result.length + 1;
          const newId = `MAK/${String(count).padStart(4, "0")}/${dateStr}`;
          callback(newId);
        };
      }

      document.addEventListener("DOMContentLoaded", function () {
        document
          .getElementById("createTaxInvoiceBtn")
          .addEventListener("click", createTaxInvoice);
        document
          .getElementById("CustomerAddressDropdown")
          .addEventListener("change", populateInvoiceAddressSections);
        document
          .getElementById("ShippingAddressDropdown")
          .addEventListener("change", populateInvoiceAddressSections);
      });

      function createTaxInvoice() {
        const invoiceDate = document.getElementById("invoiceDate").value;
        const invoiceCustomerAddress = document.getElementById(
          "CustomerAddressDropdown"
        ).value;
        const invoiceShippingAddress = document.getElementById(
          "ShippingAddressDropdown"
        ).value;
        const PdfInvoiceNumber =
          document.getElementById("PdfInvoiceNumber").value;
        const invoiceVehicalNumber =
          document.getElementById("vehicalNumber").value;
        const invoicePlaceOfSupply =
          document.getElementById("placeOfSupply").value;
        const invoiceDateAndTime = document.getElementById("dateAndTime").value;

        generateTaxInvoiceId(invoiceDate, function (newId) {
          const data = {
            id: newId,
            invoiceNumber: newId,
            PdfInvoiceNumber: PdfInvoiceNumber,
            invoiceDate: invoiceDate,
            customerAddress: invoiceCustomerAddress,
            shippingAddress: invoiceShippingAddress,
            vehicalNumber: invoiceVehicalNumber,
            placeOfSupply: invoicePlaceOfSupply,
            dateAndTime: invoiceDateAndTime,
            books: [],
          };

          const transaction = taxdb.transaction(STORE_INVOICES, "readwrite");
          const store = transaction.objectStore(STORE_INVOICES);
          store.add(data);

          transaction.oncomplete = function () {
            alert("Invoice created!");
            populateTaxInvoiceDropdown();
          };
        });
      }

      function updateTaxInvoice() {
        const id = document.getElementById("invoiceNumber").value;
        if (!id) return;

        const invoiceDate = document.getElementById("invoiceDate").value;
        const PdfInvoiceNumber =
          document.getElementById("PdfInvoiceNumber").value;
        const invoiceCustomerAddress = document.getElementById(
          "CustomerAddressDropdown"
        ).value;
        const invoiceShippingAddress = document.getElementById(
          "ShippingAddressDropdown"
        ).value;
        const invoiceVehicalNumber =
          document.getElementById("vehicalNumber").value;
        const invoicePlaceOfSupply =
          document.getElementById("placeOfSupply").value;
        const invoiceDateAndTime = document.getElementById("dateAndTime").value;

        const transaction = taxdb.transaction(STORE_INVOICES, "readwrite");
        const store = transaction.objectStore(STORE_INVOICES);

        // First get the existing invoice to preserve books
        const getRequest = store.get(id);
        getRequest.onsuccess = function () {
          const existing = getRequest.result;
          if (!existing) {
            alert("Invoice not found!");
            return;
          }

          const updated = {
            ...existing,
            invoiceDate,
            PdfInvoiceNumber: PdfInvoiceNumber,
            customerAddress: invoiceCustomerAddress,
            shippingAddress: invoiceShippingAddress,
            vehicalNumber: invoiceVehicalNumber,
            placeOfSupply: invoicePlaceOfSupply,
            dateAndTime: invoiceDateAndTime,
          };

          store.put(updated);

          transaction.oncomplete = () => alert("Invoice updated!");
        };
      }

      function deleteTaxInvoice() {
        const id = document.getElementById("invoiceNumber").value;
        if (!id) return;

        // Step 1: Delete invoice
        const txnInvoice = taxdb.transaction(STORE_INVOICES, "readwrite");
        txnInvoice.objectStore(STORE_INVOICES).delete(id);

        // Step 2: Delete related books
        const txnBooks = taxdb.transaction("STORE_BOOKS", "readwrite");
        const storeBooks = txnBooks.objectStore("STORE_BOOKS");
        const cursorRequest = storeBooks.openCursor();

        cursorRequest.onsuccess = function (event) {
          const cursor = event.target.result;
          if (cursor) {
            const record = cursor.value;
            if ((record.invoiceId || "").trim() === id.trim()) {
              cursor.delete(); // ‚úÖ Delete matching book
            }
            cursor.continue();
          }
        };

        cursorRequest.onerror = function () {
          console.error("‚ùå Failed to delete related book entries.");
        };

        // Step 3: Final cleanup
        txnInvoice.oncomplete = () => {
          alert("üóëÔ∏è Invoice and related books deleted!");
          populateTaxInvoiceDropdown();
          clearInvoiceForm();
          populateDashboardInvoiceSummary(); // ‚úÖ Refresh dashboard
        };
      }

      function clearInvoiceForm() {
        document.getElementById("invoiceNumber").value = "";
        document.getElementById("invoiceDate").value = "";
        document.getElementById("CustomerAddressDropdown").value = "";
        document.getElementById("ShippingAddressDropdown").value = "";
        document.getElementById("vehicalNumber").value = "";
        document.getElementById("placeOfSupply").value = "";
        document.getElementById("dateAndTime").value = "";
        document.getElementById("invoiceTableBody").innerHTML = "";
      }

      function populateTaxInvoiceDropdown() {
        if (!taxdb) {
          console.warn("Database not ready yet.");
          return;
        }
        const dropdown = document.getElementById("invoiceDropdown");
        dropdown.innerHTML = "<option value=''>-- Select Invoice --</option>";

        const transaction = taxdb.transaction(STORE_INVOICES, "readonly");
        const store = transaction.objectStore(STORE_INVOICES);
        const request = store.getAll();

        request.onsuccess = function () {
          request.result.forEach((item) => {
            const option = document.createElement("option");
            option.value = item.id;
            option.textContent = item.invoiceNumber;
            dropdown.appendChild(option);
          });
        };
      }

      function PrintInvoice() {
        window.print();
      }

      function loadInvoiceData() {
        const id = document.getElementById("invoiceDropdown").value;
        if (!id) return;

        const transaction = taxdb.transaction(STORE_INVOICES, "readonly");
        const store = transaction.objectStore(STORE_INVOICES);
        const request = store.get(id);

        request.onsuccess = function () {
          const data = request.result;
          if (!data) return;

          // ‚úÖ Populate invoice fields
          document.getElementById("invoiceNumber").value =
            data.invoiceNumber || "";
          document.getElementById("invoiceDate").value = data.invoiceDate || "";
          document.getElementById("PdfInvoiceNumber").value =
            data.PdfInvoiceNumber || "";

          // ‚úÖ Populate Customer & Shipping Address dropdowns
          document.getElementById("CustomerAddressDropdown").value =
            data.customerAddress || "";
          document.getElementById("ShippingAddressDropdown").value =
            data.shippingAddress || "";

          // ‚úÖ Populate other fields
          document.getElementById("vehicalNumber").value =
            data.vehicalNumber || "";
          document.getElementById("placeOfSupply").value =
            data.placeOfSupply || "";
          document.getElementById("dateAndTime").value = data.dateAndTime || "";

          // ‚úÖ Populate other fields correctly for <td> elements
          document.getElementById("invoiceCellDate").textContent =
            "Invoice Date : " + data.invoiceDate || "";
          document.getElementById("invoiceCell").textContent =
            "Invoice Number : " + data.PdfInvoiceNumber || "";
          document.getElementById("vehicalno").textContent =
            "Vehical Number : " + data.vehicalNumber || "";
          document.getElementById("placesupply").textContent =
            "Place of supply : " + data.placeOfSupply || "";
          document.getElementById("datesupply").textContent =
            "Date & Time of Supply : " + data.dateAndTime || "";

          // ‚úÖ Populate invoice table
          updateInvoiceTable(id);

          // ‚úÖ Update Customer & Shipping sections in invoice table
          populateInvoiceAddressSections();

          loadInvoiceBooksByInvoiceId(id);
        };
      }

      function createNewAddress() {
        const name = document
          .getElementById("InvoiceCustomerName")
          .value.trim();
        const address1 = document.getElementById("Address1").value.trim();
        const address2 = document.getElementById("Address2").value.trim();
        const address3 = document.getElementById("Address3").value.trim();

        highlightIfEmpty("InvoiceCustomerName");
        highlightIfEmpty("Address1");
        highlightIfEmpty("Address2");
        highlightIfEmpty("Address3");
        if (!name || !address1 || !address2 || !address3) {
          alert(
            "All fields are mandatory. Please fill in Customer Name and all Address fields."
          );
          return;
        }

        if (!name) return alert("Customer Name is required.");

        const id = `ADDR-${Date.now()}`; // Unique ID using timestamp

        const data = {
          id,
          InvoiceCustomerName: name,
          Address1: address1,
          Address2: address2,
          Address3: address3,
        };

        const txn = taxdb.transaction(STORE_ADDRESS, "readwrite");
        txn.objectStore(STORE_ADDRESS).add(data);

        txn.oncomplete = () => {
          alert("Address added!");
          populateAddressDropdown();
        };
      }

      function highlightIfEmpty(id) {
        const el = document.getElementById(id);
        if (!el.value.trim()) {
          el.style.borderColor = "red";
        } else {
          el.style.borderColor = "antiquewhite"; // reset to default
        }
      }

      function populateAddressDropdown() {
        const dropdownIds = [
          "AddressDropdownMain",
          "CustomerAddressDropdown",
          "ShippingAddressDropdown",
        ];

        dropdownIds.forEach((id) => {
          const dropdown = document.getElementById(id);
          if (dropdown) {
            dropdown.innerHTML =
              '<option value="">-- Select Address --</option>';
          }
        });

        const txn = taxdb.transaction(STORE_ADDRESS, "readonly");
        const store = txn.objectStore(STORE_ADDRESS);
        const request = store.getAll();

        request.onsuccess = () => {
          request.result.forEach((item) => {
            dropdownIds.forEach((id) => {
              const dropdown = document.getElementById(id);
              if (dropdown) {
                const option = document.createElement("option");
                option.value = item.id;
                option.textContent = item.InvoiceCustomerName;
                dropdown.appendChild(option);
              }
            });
          });
        };

        request.onerror = (event) => {
          console.error("‚ùå Error loading addresses:", event.target.error);
        };
      }

      function handleAddressSelectionMain() {
        const selectedId = document.getElementById("AddressDropdownMain").value;
        if (!selectedId) {
          clearAddressFields();
          return;
        }

        const txn = taxdb.transaction(STORE_ADDRESS, "readonly");
        const store = txn.objectStore(STORE_ADDRESS);
        const request = store.get(selectedId);

        request.onsuccess = () => {
          const data = request.result;
          if (data) {
            document.getElementById("InvoiceCustomerName").value =
              data.InvoiceCustomerName || "";
            document.getElementById("Address1").value = data.Address1 || "";
            document.getElementById("Address2").value = data.Address2 || "";
            document.getElementById("Address3").value = data.Address3 || "";
          }
        };

        request.onerror = (event) => {
          console.error("‚ùå Failed to load address:", event.target.error);
          alert("Error loading address details.");
        };
      }

      function updateAddressMain() {
        const selectedId = document.getElementById("AddressDropdownMain").value;
        if (!selectedId) {
          alert("Please select an address to update.");
          return;
        }

        const updatedData = {
          id: selectedId,
          InvoiceCustomerName: document
            .getElementById("InvoiceCustomerName")
            .value.trim(),
          Address1: document.getElementById("Address1").value.trim(),
          Address2: document.getElementById("Address2").value.trim(),
          Address3: document.getElementById("Address3").value.trim(),
        };

        const txn = taxdb.transaction(STORE_ADDRESS, "readwrite");
        const store = txn.objectStore(STORE_ADDRESS);
        const request = store.put(updatedData);

        request.onsuccess = () => {
          alert("‚úÖ Address updated successfully.");
          loadAddressDropdownMain(); // Refresh dropdown
          populateAddressDropdown();
        };

        request.onerror = (event) => {
          console.error("‚ùå Error updating address:", event.target.error);
          alert("Failed to update address.");
        };
      }

      function deleteAddressMain() {
        let selectedId = document.getElementById("AddressDropdownMain").value;
        if (!selectedId) {
          alert("Please select an address to delete.");
          return;
        }

        selectedId = parseInt(selectedId); // ‚úÖ Ensure it's a number

        const txn = taxdb.transaction(STORE_ADDRESS, "readwrite");
        const store = txn.objectStore(STORE_ADDRESS);
        const request = store.delete(selectedId);

        request.onsuccess = () => {
          console.log("‚úÖ Deleted ID:", selectedId);
          alert("Address deleted successfully.");
          clearAddressFields();
          loadAddressDropdownMain();
        };

        request.onerror = (event) => {
          console.error("‚ùå Error deleting address:", event.target.error);
          alert("Failed to delete address.");
        };
      }

      function loadAddressDropdownMain() {
        const dropdownIds = [
          "AddressDropdownMain",
          "CustomerAddressDropdown",
          "ShippingAddressDropdown",
        ];

        // Clear all dropdowns
        dropdownIds.forEach((id) => {
          const dropdown = document.getElementById(id);
          dropdown.innerHTML = '<option value="">-- Select Address --</option>';
        });

        const txn = taxdb.transaction(STORE_ADDRESS, "readonly");
        const store = txn.objectStore(STORE_ADDRESS);
        const request = store.openCursor();

        request.onsuccess = (event) => {
          const cursor = event.target.result;
          if (cursor) {
            const data = cursor.value;
            dropdownIds.forEach((id) => {
              const dropdown = document.getElementById(id);
              const option = document.createElement("option");
              option.value = data.id;
              option.textContent =
                data.InvoiceCustomerName || `Address ${data.id}`;
              dropdown.appendChild(option);
            });
            cursor.continue();
          }
        };
      }

      function deleteAddressMain() {
        const selectedId = document.getElementById("AddressDropdownMain").value;
        if (!selectedId) {
          alert("Please select an address to delete.");
          return;
        }

        const txn = taxdb.transaction(STORE_ADDRESS, "readwrite");
        const store = txn.objectStore(STORE_ADDRESS);
        const request = store.delete(selectedId); // ‚úÖ Use string ID directly

        request.onsuccess = () => {
          alert("‚úÖ Address deleted successfully.");
          clearAddressFields();
          loadAddressDropdownMain(); // Refresh dropdown
        };

        request.onerror = (event) => {
          console.error("‚ùå Error deleting address:", event.target.error);
          alert("Failed to delete address.");
        };
      }

      function logAllAddresses() {
        const txn = taxdb.transaction(STORE_ADDRESS, "readonly");
        const store = txn.objectStore(STORE_ADDRESS);
        const request = store.openCursor();

        console.log("üìã Current Address Records:");
        request.onsuccess = (event) => {
          const cursor = event.target.result;
          if (cursor) {
            console.log(cursor.value);
            cursor.continue();
          }
        };
      }

      function clearAddressFields() {
        document.getElementById("InvoiceCustomerName").value = "";
        document.getElementById("Address1").value = "";
        document.getElementById("Address2").value = "";
        document.getElementById("Address3").value = "";
      }

      function addInvoiceBookEntry() {
        try {
          const invoiceDropdown = document.getElementById("invoiceDropdown");
          const invoiceNo = invoiceDropdown?.value?.trim().toUpperCase();
          if (!invoiceNo)
            return alert("Please select a valid invoice before adding a book.");
          const fields = [
            "gooddesc",
            "goodhsn",
            "goodprice",
            "goodgst",
            "goodqty",
            "goodtotal",
          ];
          const book = { invoiceId: invoiceNo };

          for (const id of fields) {
            const el = document.getElementById(id);
            if (!el) {
              console.error(`Missing input field: ${id}`);
              throw new Error(`Missing input field: ${id}`);
            }
            const val = el.value.trim();
            if (!val) return alert("Please fill all book fields.");
            book[id] = val;
          }

          const txn = taxdb.transaction("STORE_BOOKS", "readwrite");
          const store = txn.objectStore("STORE_BOOKS");
          book.id = `${invoiceNo}-${Date.now()}`;
          const request = store.add(book);

          request.onsuccess = () => {
            alert("‚úÖ Book entry added to invoice.");
            updateInvoiceTable(invoiceNo);
          };

          request.onerror = (event) => {
            console.error("‚ùå Error adding book:", event.target.error);
            alert("Failed to add book entry.");
          };
        } catch (err) {
          console.error("‚ùå Error adding book entry:", err);
          alert(
            "Something went wrong while adding the book. Check console for details."
          );
        }
      }

      function updateInvoiceBookEntry() {
        const txn = taxdb.transaction("STORE_BOOKS", "readwrite");
        const store = txn.objectStore("STORE_BOOKS");

        const updatedEntry = {
          id: currentInvoiceBookId,
          invoiceId: document.getElementById("invoiceDropdown").value.trim(),
          gooddesc: document.getElementById("gooddesc").value.trim(),
          goodhsn: document.getElementById("goodhsn").value.trim(),
          goodgst: document.getElementById("goodgst").value.trim(),
          goodprice: document.getElementById("goodprice").value.trim(),
          goodqty: document.getElementById("goodqty").value.trim(),
          goodtotal: document.getElementById("goodtotal").value.trim(),
        };

        const request = store.put(updatedEntry);

        request.onsuccess = () => {
          alert("‚úÖ Book entry updated.");
          loadInvoiceBooksByInvoiceId(updatedEntry.invoiceId);
          updateInvoiceTable(updatedEntry.invoiceId);
        };

        request.onerror = (event) => {
          console.error("‚ùå Error updating book:", event.target.error);
          alert("Failed to update book entry.");
        };
      }

      function deleteInvoiceBookEntry() {
        const invoiceId = document
          .getElementById("invoiceDropdown")
          .value.trim();
        if (!currentInvoiceBookId) return alert("No book selected to delete.");

        const txn = taxdb.transaction("STORE_BOOKS", "readwrite");
        const store = txn.objectStore("STORE_BOOKS");
        const request = store.delete(currentInvoiceBookId);

        request.onsuccess = () => {
          alert("‚úÖ Book entry deleted.");
          loadInvoiceBooksByInvoiceId(invoiceId);
          updateInvoiceTable(invoiceId);
        };

        request.onerror = (event) => {
          console.error("‚ùå Error deleting book:", event.target.error);
          alert("Failed to delete book entry.");
        };
      }

      function calculateTotalPrice() {
        const unitPrice =
          parseFloat(document.getElementById("goodprice").value) || 0;
        const quantity =
          parseInt(document.getElementById("goodqty").value) || 0;
        document.getElementById("goodtotal").value = (
          unitPrice * quantity
        ).toFixed(2);
      }

      function loadInvoiceBooksByInvoiceId(invoiceId) {
        invoiceBookEntries = [];
        const txn = taxdb.transaction("STORE_BOOKS", "readonly");
        const store = txn.objectStore("STORE_BOOKS");
        const index = store.index("invoiceId");
        const request = index.getAll(invoiceId);

        request.onsuccess = function () {
          invoiceBookEntries = request.result;
          if (invoiceBookEntries.length > 0) {
            currentIndex = 0;
            showInvoiceBook(currentIndex);
          } else {
            document.getElementById("invoiCerecordCount").textContent =
              "No records";
          }
        };
      }

      function showInvoiceBook(index) {
        const entry = invoiceBookEntries[index];
        if (!entry) return;

        currentInvoiceBookId = entry.id;

        document.getElementById("gooddesc").value = entry.gooddesc || "";
        document.getElementById("goodhsn").value = entry.goodhsn || "";
        document.getElementById("goodgst").value = entry.goodgst || "";
        document.getElementById("goodprice").value = entry.goodprice || "";
        document.getElementById("goodqty").value = entry.goodqty || "";
        document.getElementById("goodtotal").value = entry.goodtotal || "";

        document.getElementById("invoiCerecordCount").textContent = `Record ${
          index + 1
        } of ${invoiceBookEntries.length}`;
      }

      function updateInvoiceTable(invoiceId) {
        const tableBody = document.getElementById("booksBody");
        tableBody.innerHTML = ""; // Clear previous rows

        const txn = taxdb.transaction("STORE_BOOKS", "readonly");
        const store = txn.objectStore("STORE_BOOKS");
        const index = store.index("invoiceId");
        const request = index.getAll(invoiceId);

        request.onsuccess = () => {
          const books = request.result;
          let totalAmount = 0;

          books.forEach((book, i) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
		  <td>${i + 1}</td>
		  <td>${book.gooddesc}</td>
		  <td>${book.goodhsn}</td>
		  <td>${book.goodgst}</td>
		  <td>${book.goodqty}</td>
		  <td>${book.goodtotal}</td>
		`;
            tableBody.appendChild(tr);

            totalAmount += parseFloat(book.goodtotal) || 0;
          });

          document.getElementById("Totalamount").textContent =
            totalAmount.toFixed(2);
          document.getElementById("Totalamount1").textContent =
            totalAmount.toFixed(2);
          document.getElementById("TotalGST").textContent = (
            totalAmount * 0.05
          ).toFixed(2); // Assuming 5% GST
          document.getElementById("grossTotal").textContent = (
            totalAmount +
            totalAmount * 0.05
          ).toFixed(2);
        };
      }

      function getAddressById(id, callback) {
        if (!id) {
          console.warn("‚ö†Ô∏è Address ID is empty");
          callback({});
          return;
        }

        const txn = taxdb.transaction(STORE_ADDRESS, "readonly");
        const store = txn.objectStore(STORE_ADDRESS);
        const request = store.get(id);

        request.onsuccess = () => {
          if (!request.result) {
            console.warn("‚ö†Ô∏è No address found for ID:", id);
          }
          callback(request.result || {});
        };

        request.onerror = () => {
          console.error("‚ùå Failed to fetch address for ID:", id);
          callback({});
        };
      }

      function populateInvoiceAddressSections() {
        const customerId = document.getElementById(
          "CustomerAddressDropdown"
        ).value;
        const shippingId = document.getElementById(
          "ShippingAddressDropdown"
        ).value;

        getAddressById(customerId, (customer) => {
          document.getElementById("invoicecustomername").textContent =
            customer.InvoiceCustomerName || "";
          document.getElementById("invoiceaddress1").textContent =
            customer.Address1 || "";
          document.getElementById("invoiceaddress2").textContent =
            customer.Address2 || "";
          document.getElementById("invoiceaddress3").textContent =
            customer.Address3 || "";
        });

        getAddressById(shippingId, (shipping) => {
          document.getElementById("shippingcustomer").textContent =
            shipping.InvoiceCustomerName || "";
          document.getElementById("shippingAddress1").textContent =
            shipping.Address1 || "";
          document.getElementById("shippingAddress2").textContent =
            shipping.Address2 || "";
          document.getElementById("shippingAddress3").textContent =
            shipping.Address3 || "";
        });
      }

      window.addEventListener("load", () => {
        initInvoicetaxdb();
        populateTaxInvoiceDropdown();
        loadAddressDropdownMain();
        loadAllInvoiceBooks();
      });
      document.getElementById("prevInvoiceBtn").onclick = function () {
        if (currentIndex > 0) {
          currentIndex--;
          showInvoiceBook(currentIndex);
        }
      };
      document.getElementById("nextInvoiceBtn").onclick = function () {
        if (currentIndex < invoiceBookEntries.length - 1) {
          currentIndex++;
          showInvoiceBook(currentIndex);
        }
      };
      document
        .getElementById("goodprice")
        .addEventListener("input", calculateTotalPrice);
      document
        .getElementById("goodqty")
        .addEventListener("input", calculateTotalPrice);
      document.getElementById("prevInvoiceBtn").onclick = function () {
        if (currentIndex > 0) {
          currentIndex--;
          showInvoiceBook(currentIndex);
        }
      };
      document.getElementById("nextInvoiceBtn").onclick = function () {
        if (currentIndex < invoiceBookEntries.length - 1) {
          currentIndex++;
          showInvoiceBook(currentIndex);
        }
      };
      document
        .getElementById("goodprice")
        .addEventListener("input", calculateTotalPrice);
      document
        .getElementById("goodqty")
        .addEventListener("input", calculateTotalPrice);
    </script>

    <script>
      // ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ RADDI PAGE SCRIPT START ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ

      let raddiDB;

      window.addEventListener("load", () => {
        const openRequest = indexedDB.open("RaddiDB", 1);
        openRequest.onupgradeneeded = (e) => {
          raddiDB = e.target.result;
          raddiDB.createObjectStore("baseTemplate", { keyPath: "id" });
          raddiDB.createObjectStore("raddiEntries", { keyPath: "id" });
        };
        openRequest.onsuccess = (e) => {
          raddiDB = e.target.result;
          seedBaseTemplate(); // ‚úÖ Ensure baseTemplate exists
          loadBaseTemplate();
          loadRaddiDropdown();
          raddiDBReady = true;
          tryPopulateDashboard();
          populateRaddiMonthYearFilters();
        };
      });

      function seedBaseTemplate() {
        const tx = raddiDB.transaction("baseTemplate", "readwrite");
        const store = tx.objectStore("baseTemplate");
        store.get("schema").onsuccess = (e) => {
          if (!e.target.result) {
            store.put({
              id: "schema",
              categories: [
                { name: "Paper", rate: 10 },
                { name: "Plastic", rate: 20 },
              ],
            });
          }
        };
      }

      function loadBaseTemplate() {
        const tx = raddiDB.transaction("baseTemplate", "readonly");
        const store = tx.objectStore("baseTemplate");
        store.get("schema").onsuccess = (e) => {
          const data = e.target.result?.categories || [];
          renderBaseTable(data);
          renderRaddiColumnCheckboxes(data); // ‚úÖ Add this line
        };
      }

      function renderBaseTable(categories) {
        const tbody = document.querySelector("#base-table tbody");
        tbody.innerHTML = "";
        categories.forEach((cat, i) => {
          const row = document.createElement("tr");
          row.innerHTML = `
      <td><input value="${cat.name}" onchange="updateBase(${i}, 'name', this.value)" /></td>
      <td><input type="number" value="${cat.rate}" onchange="updateBase(${i}, 'rate', this.value)" /></td>
      <td><button onclick="removeBaseRow(${i})">üóëÔ∏è</button></td>
    `;
          tbody.appendChild(row);
        });
      }

      function renderRaddiColumnCheckboxes(categories) {
        const container = document.getElementById("Raddi_Columns");
        container.innerHTML = "<strong>Select Columns:</strong><br>";

        categories.forEach((cat) => {
          const name = cat.name;
          container.innerHTML += `
      <label>
        <input type="checkbox" class="raddi-col" data-type="weight" value="${name}"> ${name} (Weight)
      </label>
      <label>
        <input type="checkbox" class="raddi-col" data-type="price" value="${name}"> ${name} (Price)
      </label>
      <br>
    `;
        });

        // Attach listener
        document.querySelectorAll(".raddi-col").forEach((cb) => {
          cb.addEventListener("change", populateRaddiDashboard);
        });
      }

      function updateBase(index, field, value) {
        const tx = raddiDB.transaction("baseTemplate", "readwrite");
        const store = tx.objectStore("baseTemplate");

        store.get("schema").onsuccess = (e) => {
          const data = e.target.result;
          if (!data || !data.categories[index]) return;

          // Update base template
          if (field === "rate") {
            data.categories[index].rate = parseFloat(value);
          } else {
            data.categories[index].name = value;
          }
          store.put(data);

          // üîÅ Sync name/rate to all Raddi entries
          const raddiTx = raddiDB.transaction("raddiEntries", "readwrite");
          const raddiStore = raddiTx.objectStore("raddiEntries");

          raddiStore.getAll().onsuccess = (ev) => {
            const entries = ev.target.result;
            entries.forEach((entry) => {
              if (entry.categories && entry.categories[index]) {
                if (field === "rate") {
                  entry.categories[index].rate = parseFloat(value);
                } else {
                  entry.categories[index].name = value;
                }
                raddiStore.put(entry);
              }
            });

            // Optional: refresh view if selected
            const selectedId = document.getElementById("raddi-selector").value;
            if (selectedId) viewRaddi();
          };
        };
      }

      function addBaseRow() {
        const tx = raddiDB.transaction("baseTemplate", "readwrite");
        const store = tx.objectStore("baseTemplate");

        store.get("schema").onsuccess = (e) => {
          const data = e.target.result || { id: "schema", categories: [] };

          // üÜï Add new category with default name/rate
          const newCategory = { name: "New", rate: 0 };
          data.categories.push(newCategory);
          store.put(data);

          renderBaseTable(data.categories);
          renderRaddiColumnCheckboxes(data.categories);

          // üîÅ Propagate to all existing Raddi entries
          const raddiTx = raddiDB.transaction("raddiEntries", "readwrite");
          const raddiStore = raddiTx.objectStore("raddiEntries");

          raddiStore.getAll().onsuccess = (ev) => {
            const entries = ev.target.result;

            entries.forEach((entry) => {
              // ‚úÖ Use the actual last category from baseTemplate
              const latestCategory =
                data.categories[data.categories.length - 1];
              entry.categories.push({ ...latestCategory, weight: 0 });

              raddiStore.put(entry).onsuccess = () => {
                console.log(
                  `‚úÖ Updated ${entry.id} with category "${latestCategory.name}"`
                );
              };
            });

            // üîÑ Refresh view if one is selected
            const selectedId = document.getElementById("raddi-selector").value;
            if (selectedId) viewRaddi();
          };
        };
      }

      function removeBaseRow(index) {
        const tx = raddiDB.transaction("baseTemplate", "readwrite");
        const store = tx.objectStore("baseTemplate");
        store.get("schema").onsuccess = (e) => {
          const data = e.target.result;
          data.categories.splice(index, 1);
          store.put(data);
          renderBaseTable(data.categories);
        };
      }

      function deleteRaddi() {
        const date = document.getElementById("raddi-date").value;
        if (!date) return alert("Select a date");

        const id = `Raddi-${date}`;
        const tx = raddiDB.transaction("raddiEntries", "readwrite");
        const store = tx.objectStore("raddiEntries");

        const request = store.delete(id);
        request.onsuccess = () => {
          removeFromDropdown(id);
          populateRaddiMonthYearFilters();
          alert("üóëÔ∏è Raddi deleted!");
        };
        request.onerror = () => {
          alert("‚ùå Failed to delete Raddi.");
        };
      }

      function createRaddi() {
        const date = document.getElementById("raddi-date").value;
        if (!date) return alert("Select a date");
        const id = `Raddi-${date}`;
        const tx = raddiDB.transaction("baseTemplate", "readonly");
        const store = tx.objectStore("baseTemplate");
        store.get("schema").onsuccess = (e) => {
          const categories = e.target.result?.categories || [];
          const entry = {
            id,
            categories: categories.map((cat) => ({ ...cat, weight: 0 })),
          };
          raddiDB
            .transaction("raddiEntries", "readwrite")
            .objectStore("raddiEntries")
            .put(entry);
          addToDropdown(id);
          populateRaddiMonthYearFilters();
          alert("‚úÖ Raddi created!");
        };
      }

      function removeRaddi(id) {
        if (!confirm(`Are you sure you want to delete ${id}?`)) return;

        const tx = raddiDB.transaction("raddiEntries", "readwrite");
        const store = tx.objectStore("raddiEntries");
        store.delete(id).onsuccess = () => {
          // Remove from dropdown
          const dropdown = document.getElementById("raddi-selector");
          [...dropdown.options].forEach((opt) => {
            if (opt.value === id) dropdown.removeChild(opt);
          });

          // Clear view
          document.getElementById("raddi-view").innerHTML = "";
          alert("üóëÔ∏è Raddi deleted successfully!");
        };
      }

      function updateRaddi(id) {
        const tx = raddiDB.transaction("raddiEntries", "readwrite");
        const store = tx.objectStore("raddiEntries");
        store.get(id).onsuccess = (e) => {
          const entry = e.target.result;
          const rows = document.querySelectorAll("#raddi-view table tbody tr");
          rows.forEach((row, i) => {
            const weight = parseFloat(
              row.children[1].querySelector("input").value
            );
            const rate = parseFloat(
              row.children[2].querySelector("input").value
            );
            entry.categories[i].weight = weight;
            entry.categories[i].rate = rate;
          });
          store.put(entry);
          alert("üíæ Raddi updated successfully!");
        };
      }

      function handleUpdateRaddi() {
        const id = document.getElementById("raddi-selector").value;
        if (!id) return alert("‚ö†Ô∏è Select a Raddi first");
        updateRaddi(id);
      }

      function handleDeleteRaddi() {
        const id = document.getElementById("raddi-selector").value;
        if (!id) return alert("‚ö†Ô∏è Select a Raddi first");
        removeRaddi(id);
      }

      function addToDropdown(id) {
        const dropdown = document.getElementById("raddi-selector");
        if ([...dropdown.options].some((opt) => opt.value === id)) return;
        const option = document.createElement("option");
        option.value = id;
        option.textContent = id;
        dropdown.appendChild(option);
      }

      function loadRaddiDropdown() {
        const tx = raddiDB.transaction("raddiEntries", "readonly");
        const store = tx.objectStore("raddiEntries");
        store.getAll().onsuccess = (e) => {
          e.target.result.forEach((entry) => addToDropdown(entry.id));
        };
      }

      function viewRaddi() {
        const id = document.getElementById("raddi-selector").value;
        if (!id) return;
        const tx = raddiDB.transaction("raddiEntries", "readonly");
        const store = tx.objectStore("raddiEntries");
        store.get(id).onsuccess = (e) => {
          const entry = e.target.result;
          renderRaddiTable(entry);
        };
      }

      function renderRaddiTable(entry) {
        const container = document.getElementById("raddi-view");
        container.innerHTML = `<h3>${entry.id}</h3>`;
        const table = document.createElement("table");
        table.innerHTML = `
    <thead><tr><th>Category</th><th>Weight</th><th>Rate</th><th>Amount</th><th>Actions</th></tr></thead>
    <tbody></tbody>
    <tfoot><tr><td colspan="4" style="text-align:right"><strong>Total:</strong></td><td id="total-amount">0.00</td></tr></tfoot>
  `;

        let total = 0;
        entry.categories.forEach((cat, i) => {
          const amount = cat.weight * cat.rate;
          total += amount;
          const row = document.createElement("tr");
          row.innerHTML = `
      <td>${cat.name}</td>
      <td><input type="number" value="${
        cat.weight
      }" onchange="updateLiveAmount('${
            entry.id
          }', ${i}, this.value, null)" /></td>
      <td><input type="number" value="${
        cat.rate
      }" onchange="updateLiveAmount('${
            entry.id
          }', ${i}, null, this.value)" /></td>
      <td id="amt-${i}">${amount.toFixed(2)}</td>
      <td><button onclick="deleteRaddiCategory('${
        entry.id
      }', ${i})">üóëÔ∏è</button></td>
    `;
          table.querySelector("tbody").appendChild(row);
        });

        table.querySelector("#total-amount").textContent = total.toFixed(2);
        container.appendChild(table);
      }

      function deleteRaddiCategory(raddiId, index) {
        const tx = raddiDB.transaction("raddiEntries", "readwrite");
        const store = tx.objectStore("raddiEntries");

        store.get(raddiId).onsuccess = (e) => {
          const entry = e.target.result;
          if (!entry || !entry.categories || index >= entry.categories.length)
            return;

          entry.categories.splice(index, 1); // Remove category
          store.put(entry).onsuccess = () => {
            viewRaddi(); // üîÅ Refresh view
            alert("üóëÔ∏è Category deleted from Raddi.");
          };
        };
      }

      function updateLiveAmount(id, index, newWeight, newRate) {
        const tx = raddiDB.transaction("raddiEntries", "readwrite");
        const store = tx.objectStore("raddiEntries");
        store.get(id).onsuccess = (e) => {
          const entry = e.target.result;
          if (newWeight !== null)
            entry.categories[index].weight = parseFloat(newWeight);
          if (newRate !== null)
            entry.categories[index].rate = parseFloat(newRate);

          const { weight, rate } = entry.categories[index];
          const amount = weight * rate;
          document.getElementById(`amt-${index}`).textContent =
            amount.toFixed(2);

          const total = entry.categories.reduce(
            (sum, cat) => sum + cat.weight * cat.rate,
            0
          );
          document.getElementById("total-amount").textContent =
            total.toFixed(2);

          store.put(entry); // Optional auto-save
        };
      }

      function handleViewedRaddiUpdate() {
        const id = document.getElementById("raddi-selector").value;
        if (!id) return alert("‚ö†Ô∏è Select a Raddi first");
        updateViewedRaddi(id);
      }

      function populateRaddiMonthYearFilters() {
        const monthDropdown = document.getElementById("raddi-month-filter");
        const yearDropdown = document.getElementById("raddi-year-filter");

        if (!monthDropdown || !yearDropdown) {
          console.warn("Month or Year filter dropdown not found.");
          return;
        }

        const monthSet = new Set();
        const yearSet = new Set();

        const tx = raddiDB.transaction("raddiEntries", "readonly");
        const store = tx.objectStore("raddiEntries");
        const request = store.getAll();

        request.onsuccess = (event) => {
          const entries = event.target.result;

          entries.forEach((entry) => {
            const dateStr = entry.id.replace("Raddi-", ""); // Format: YYYY-MM-DD
            const [year, month] = dateStr.split("-");
            if (year && month) {
              yearSet.add(year);
              monthSet.add(month);
            }
          });

          // Clear existing options
          monthDropdown.innerHTML = `<option value="">-- Select Month --</option>`;
          yearDropdown.innerHTML = `<option value="">-- Select Year --</option>`;

          // Populate months (sorted)
          [...monthSet].sort().forEach((month) => {
            const monthName = new Date(`2000-${month}-01`).toLocaleString(
              "default",
              { month: "long" }
            );
            const option = document.createElement("option");
            option.value = month;
            option.textContent = monthName;
            monthDropdown.appendChild(option);
          });

          // Populate years (sorted)
          [...yearSet].sort().forEach((year) => {
            const option = document.createElement("option");
            option.value = year;
            option.textContent = year;
            yearDropdown.appendChild(option);
          });
        };

        request.onerror = () => {
          console.error(
            "‚ùå Failed to fetch Raddi entries for filter population."
          );
        };
      }

      function updateViewedRaddi(id) {
        const tx = raddiDB.transaction("raddiEntries", "readwrite");
        const store = tx.objectStore("raddiEntries");
        store.get(id).onsuccess = (e) => {
          const entry = e.target.result;
          const rows = document.querySelectorAll("#raddi-view table tbody tr");
          rows.forEach((row, i) => {
            const weight = parseFloat(
              row.children[1].querySelector("input").value
            );
            const rate = parseFloat(
              row.children[2].querySelector("input").value
            );
            entry.categories[i].weight = weight;
            entry.categories[i].rate = rate;
          });
          store.put(entry);
          alert("‚úÖ Raddi updated successfully!");
        };
      }

      document.getElementById("update-raddi-btn").style.display =
        "inline-block";
      document.getElementById("delete-raddi-btn").style.display =
        "inline-block";
      document
        .getElementById("raddi-month-filter")
        .addEventListener("change", populateRaddiDashboard);
      document
        .getElementById("raddi-year-filter")
        .addEventListener("change", populateRaddiDashboard);
    </script>

    <script>
      // ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ IMPORT AND EXPORT DB START ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ

      async function exportAllData() {
        const databases = [
          {
            name: "QuotationDB",
            version: 10,
            stores: ["quotations", "quotationDetails"],
          },
          {
            name: "TaxInvoicetaxdb",
            version: 3,
            stores: ["TaxInvoices", "TaxAddress", "STORE_BOOKS"],
          },
          {
            name: "RaddiDB",
            version: 1,
            stores: ["baseTemplate", "raddiEntries"],
          },
          {
            name: "SchemaDB",
            version: 1,
            stores: ["schemas", "navigationMeta"],
          },
        ];

        const fullExport = {};

        for (const dbInfo of databases) {
          try {
            const db = await openDB(dbInfo.name);
            fullExport[dbInfo.name] = {};

            for (const storeName of dbInfo.stores) {
              if (!db.objectStoreNames.contains(storeName)) {
                console.warn(
                  `‚ö†Ô∏è Store ${storeName} not found in ${dbInfo.name}`
                );
                continue;
              }

              const tx = db.transaction(storeName, "readonly");
              const store = tx.objectStore(storeName);

              const data = await new Promise((resolve, reject) => {
                const req = store.getAll();
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
              });

              fullExport[dbInfo.name][storeName] = data;
            }

            db.close();
          } catch (err) {
            console.error(`‚ùå Failed to export ${dbInfo.name}:`, err);
            fullExport[dbInfo.name] = { error: err.message };
          }
        }

        const blob = new Blob([JSON.stringify(fullExport, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `MAK_DB_Backup_${new Date()
          .toISOString()
          .slice(0, 10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
      }

      function openDB(name, version) {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(name, version);
          request.onsuccess = () => resolve(request.result);
          request.onerror = () => reject(request.error);
        });
      }

      function triggerImport() {
        const input = document.createElement("input");
        input.type = "file";
        input.accept = ".json";

        input.onchange = () => {
          const file = input.files[0];
          if (file) {
            importAllData(file);
          } else {
            alert("‚ùå No file selected");
          }
        };

        input.click();
      }

      function getRecordIfExists(store, key) {
        return new Promise((resolve) => {
          const req = store.get(key);
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => resolve(null);
        });
      }

      async function importAllData(file) {
        const reader = new FileReader();

        reader.onload = async function () {
          let data;
          try {
            data = JSON.parse(reader.result);
          } catch (err) {
            alert("‚ùå Invalid JSON file");
            console.error("Parse error:", err);
            return;
          }

          for (const dbName in data) {
            try {
              const db = await openDB(dbName);
              for (const storeName in data[dbName]) {
                if (!db.objectStoreNames.contains(storeName)) {
                  console.warn(`‚ö†Ô∏è Store ${storeName} not found in ${dbName}`);
                  continue;
                }

                const tx = db.transaction(storeName, "readwrite");
                const store = tx.objectStore(storeName);
                let skippedCount = 0;

                for (const record of data[dbName][storeName]) {
                  try {
                    // ‚úÖ Normalize schema format
                    if (dbName === "SchemaDB" && storeName === "schemas") {
                      if (record.columns) {
                        record.fields = record.columns;
                        delete record.columns;
                      }
                    }

                    // ‚úÖ Prevent duplicates
                    const key = record.id || record.recordId;
                    const existing = await getRecordIfExists(store, key);
                    if (!existing) {
                      store.add(record);
                    } else {
                      skippedCount++;
                    }
                  } catch (err) {
                    console.error(
                      `‚ùå Failed to import into ${storeName}:`,
                      err,
                      record
                    );
                  }
                }

                tx.oncomplete = () => {
                  console.log(
                    `‚úÖ Imported ${storeName} in ${dbName}, skipped ${skippedCount} duplicates`
                  );
                };

                tx.onerror = () => {
                  console.error(
                    `‚ùå Transaction failed for ${storeName} in ${dbName}`
                  );
                };
              }

              // ‚úÖ Rehydrate localStorage for SchemaDB ‚Üí allSchemas
              if (dbName === "SchemaDB") {
                const tx1 = db.transaction("schemas", "readonly");
                const store1 = tx1.objectStore("schemas");
                const allSchemasArr = await new Promise((resolve) => {
                  const req = store1.getAll();
                  req.onsuccess = () => resolve(req.result);
                  req.onerror = () => resolve([]);
                });

                const schemaObj = {};
                allSchemasArr.forEach((s) => {
                  schemaObj[s.id] = { columns: s.fields };
                });
                localStorage.setItem("allSchemas", JSON.stringify(schemaObj));

                // ‚úÖ Rehydrate localStorage for navigationMeta ‚Üí allData
                const tx2 = db.transaction("navigationMeta", "readonly");
                const store2 = tx2.objectStore("navigationMeta");
                const allMeta = await new Promise((resolve) => {
                  const req = store2.getAll();
                  req.onsuccess = () => resolve(req.result);
                  req.onerror = () => resolve([]);
                });

                const dataObj = {};
                allMeta.forEach((m) => {
                  dataObj[m.id] = m.data || [];
                });
                localStorage.setItem("allData", JSON.stringify(dataObj));
              }

              db.close();
            } catch (err) {
              console.error(`‚ùå Failed to open DB ${dbName}:`, err);
            }
          }

          alert("‚úÖ Import completed!");

          // ‚úÖ Rehydrate memory and UI
          loadSchemas();
          loadData();

          document.getElementById("pages").innerHTML = "";
          document.getElementById("dynamic-pages").innerHTML = "";

          renderSchemaDropdown();
          renderNavigation();

          Object.keys(allSchemas).forEach((name) => {
            createSchemaPage(name);
            addSidebarLink(name);
          });

          const first = Object.keys(allSchemas)[0];
          if (first) onSchemaChange(first);

          tryPopulateDashboard?.();
        };

        reader.onerror = () => {
          alert("‚ùå Failed to read file");
          console.error("FileReader error:", reader.error);
        };

        reader.readAsText(file);
      }

      // ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ IMPORT AND EXPORT DB END ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ
    </script>

    <script>
      /* ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ SCHEMA SCRIPT START ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ‚úÖ */

      let allSchemas = JSON.parse(localStorage.getItem("allSchemas")) || {};
      let allData = JSON.parse(localStorage.getItem("allData")) || {};
      let activeSchemaName = Object.keys(allSchemas)[0] || null;
      let schema = activeSchemaName ? allSchemas[activeSchemaName] : [];
      let data = activeSchemaName ? allData[activeSchemaName] : [];
      let currentColIndex = 0;
      let currentEntryIndex = {};

      function initSchemaDB() {
        const request = indexedDB.open("SchemaDB", 1);

        request.onupgradeneeded = function (event) {
          const db = event.target.result;

          if (!db.objectStoreNames.contains("schemas")) {
            db.createObjectStore("schemas", { keyPath: "id" });
          }

          if (!db.objectStoreNames.contains("navigationMeta")) {
            db.createObjectStore("navigationMeta", { keyPath: "id" });
          }
        };

        request.onsuccess = function () {
          console.log("‚úÖ SchemaDB initialized");
        };

        request.onerror = function (event) {
          console.error(
            "‚ùå Failed to initialize SchemaDB:",
            event.target.error
          );
        };
      }

      function saveSchemaToDB(schemaId, fieldsArray) {
        const request = indexedDB.open("SchemaDB", 1);

        request.onsuccess = function (event) {
          const db = event.target.result;
          const tx = db.transaction("schemas", "readwrite");
          const store = tx.objectStore("schemas");
          store.put({ id: schemaId, fields: fieldsArray });

          tx.oncomplete = () =>
            console.log(`‚úÖ Saved schema "${schemaId}" to SchemaDB`);
          tx.onerror = () =>
            console.error("‚ùå Failed to save schema to SchemaDB");
        };
      }

      function addColumn() {
        const name = colName.value.trim();
        if (!name) return;

        const schemaCols = allSchemas[activeSchemaName].columns;

        // Prevent duplicate column names
        if (schemaCols.some((col) => col.name === name)) {
          alert("Column name already exists.");
          return;
        }

        schemaCols.push({
          name,
          formula: colFormula.value.trim(),
          type: colType.value,
          required: colRequired.checked,
        });

        saveSchema();

        renderColumnForm();
        renderFormFields(activeSchemaName); // ‚úÖ Prepare inputs
        renderTableColumns(activeSchemaName); // ‚úÖ Prepare headers
        renderForm(); // ‚úÖ Populate form
        renderTable(activeSchemaName); // ‚úÖ Populate table
      }

      function updateColumn() {
        schema[currentColIndex] = {
          name: colName.value.trim(),
          formula: colFormula.value.trim(),
          type: colType.value,
          required: colRequired.checked,
        };

        saveSchema();
        renderColumnForm();
        renderForm();
        renderTable();
        renderFormFields(activeSchemaName); // ‚úÖ Add this
        renderTableColumns(activeSchemaName); // ‚úÖ Add this
      }

      function deleteColumn() {
        schema.splice(currentColIndex, 1);
        currentColIndex = Math.max(0, currentColIndex - 1);

        saveSchema(); // ‚úÖ This now updates both localStorage and IndexedDB
        renderColumnForm();
        renderForm();
        renderTable();
        renderFormFields(activeSchemaName);
        renderTableColumns(activeSchemaName);
      }

      function renderColumnForm() {
        const col = schema[currentColIndex] || {};
        colName.value = col.name || "";
        colFormula.value = col.formula || "";
        colType.value = col.type || "text";
        colRequired.checked = col.required || false;
        colRecordLabel.textContent = `Column ${currentColIndex + 1} of ${
          schema.length
        }`;

        // Show rearrange buttons
        document.getElementById("reorderControls").style.display = "block";
        document.getElementById("moveUpBtn").disabled = currentColIndex === 0;
        document.getElementById("moveDownBtn").disabled =
          currentColIndex === schema.length - 1;
      }

      function moveColumnUp() {
        if (currentColIndex > 0) {
          [schema[currentColIndex - 1], schema[currentColIndex]] = [
            schema[currentColIndex],
            schema[currentColIndex - 1],
          ];
          currentColIndex--;
          saveSchema();
          renderColumnForm();
          renderFormFields(activeSchemaName);
          renderTableColumns(activeSchemaName);
          renderTable(activeSchemaName);
        }
      }

      function moveColumnDown() {
        if (currentColIndex < schema.length - 1) {
          [schema[currentColIndex + 1], schema[currentColIndex]] = [
            schema[currentColIndex],
            schema[currentColIndex + 1],
          ];
          currentColIndex++;
          saveSchema();
          renderColumnForm();
          renderFormFields(activeSchemaName);
          renderTableColumns(activeSchemaName);
          renderTable(activeSchemaName);
        }
      }

      function nextColumn() {
        if (currentColIndex < schema.length - 1) currentColIndex++;
        renderColumnForm();
      }

      function prevColumn() {
        if (currentColIndex > 0) currentColIndex--;
        renderColumnForm();
      }

      function showPageById(id) {
        document
          .querySelectorAll(".page")
          .forEach((p) => p.classList.remove("active"));
        const target = document.getElementById(id);
        if (target) target.classList.add("active");

        // Hide menu
        menuVisible = false;
        document.getElementById("sideMenu").style.left = "-200px";
      }

      function renderForm(entry = {}) {
        const container = document.getElementById(`form-${activeSchemaName}`);
        if (!container) return;
        container.innerHTML = schema
          .map((col) => {
            const val = entry[col.name] || "";
            return `<label>${col.name}<input type="${col.type}" name="${col.name}" value="${val}" /></label>`;
          })
          .join("");
      }

      function saveEntry(event, schemaName) {
        event.preventDefault();

        const inputs = document.querySelectorAll(
          `#formFields-${schemaName} input`
        );
        const entry = {};

        inputs.forEach((input) => {
          entry[input.name] = input.value;
        });

        // ‚úÖ Evaluate formulas
        const schemaCols = allSchemas[schemaName].columns;
        schemaCols.forEach((col) => {
          if (col.formula) {
            try {
              const formula = col.formula;
              const context = { ...entry };
              const result = Function(
                ...Object.keys(context),
                `return ${formula}`
              )(...Object.values(context));
              entry[col.name] = result;
            } catch (err) {
              console.warn(`‚ö†Ô∏è Formula error in column "${col.name}":`, err);
            }
          }
        });

        if (!allData[schemaName]) allData[schemaName] = [];

        // ‚úÖ Auto-increment S.No
        entry["S.No"] = (allData[schemaName]?.length || 0) + 1;

        allData[schemaName].push(entry);
        currentEntryIndex[schemaName] = allData[schemaName].length - 1;

        saveData();
        renderTable(schemaName);
        showEntry(schemaName);
        alert(`‚úÖ Entry saved with S.No: ${entry["S.No"]}`);
      }

      function renderTable(schemaName) {
        const table = document.getElementById(`dataTable-${schemaName}`);
        const tbody = table.querySelector("tbody");
        const schema = allSchemas[schemaName].columns;
        const entries = allData[schemaName] || [];

        tbody.innerHTML = "";

        entries.forEach((entry, index) => {
          const row = document.createElement("tr");
          row.onclick = () => {
            currentEntryIndex[schemaName] = index;
            showEntry(schemaName);
          };

          row.innerHTML = schema
            .map((col) => `<td>${entry[col.name] || ""}</td>`)
            .join("");

          tbody.appendChild(row);
        });

        document.getElementById(
          `entryRecordLabel-${schemaName}`
        ).textContent = `Total: ${entries.length}`;
      }

      function onSchemaChange(name) {
        activeSchemaName = name;
        schema = allSchemas[name]?.columns || []; // ‚úÖ Use .columns
        data = allData[name] || [];
        currentColIndex = 0;
        currentEntryIndex[schemaName] =
          allData[schemaName]?.length > 0 ? 0 : -1;
        renderColumnForm();
        renderForm();
        renderTable();
        showPageBySchema(name);
      }

      function createNewSchema() {
        const name = prompt("Enter schema name:");
        if (!name || allSchemas[name]) return;

        if (/\s/.test(name)) {
          alert(
            "Schema name cannot contain spaces. Use underscores (_) or camelCase."
          );
          return;
        }

        allSchemas[name] = {
          columns: [], // ‚úÖ Start with empty columns
        };

        allData[name] = [];
        currentEntryIndex[name] = -1;
        activeSchemaName = name;
        schema = []; // ‚úÖ Reset schema reference
        data = [];

        saveSchema();
        saveData();

        renderSchemaDropdown();
        createSchemaPage(name);
        addSidebarLink(name);
        showPageBySchema(name);

        renderColumnForm();
        renderFormFields(name);
        renderTableColumns(name);
        renderTable(name);
      }

      function deleteSchema() {
        if (!activeSchemaName) return alert("No schema selected.");
        if (!confirm(`Delete schema "${activeSchemaName}" and all its data?`))
          return;

        const name = activeSchemaName;

        // Remove from memory
        delete allSchemas[name];
        delete allData[name];
        delete currentEntryIndex[name];

        // Save updated data BEFORE resetting activeSchemaName
        localStorage.setItem("allSchemas", JSON.stringify(allSchemas));
        localStorage.setItem("allData", JSON.stringify(allData));

        // Remove page
        const page = document.getElementById(`page-${name}`);
        if (page) page.remove();

        // Remove sidebar link
        const link = document.getElementById(`link-${name}`);
        if (link) link.remove();

        // Remove dropdown option
        const selector = document.getElementById("schemaSelector");
        const option = selector.querySelector(`option[value="${name}"]`);
        if (option) option.remove();

        // Reset state
        activeSchemaName = null;
        schema = [];
        data = [];

        renderSchemaDropdown();
        alert(`üóëÔ∏è Schema "${name}" deleted.`);
      }

      function saveSchema() {
        if (activeSchemaName) {
          allSchemas[activeSchemaName] = { columns: schema };
          localStorage.setItem("allSchemas", JSON.stringify(allSchemas));
          saveSchemaToDB(activeSchemaName, schema); // ‚úÖ Sync to IndexedDB
        }
      }

      function loadSchemas() {
        const saved = localStorage.getItem("allSchemas");
        if (saved) {
          allSchemas = JSON.parse(saved);
        }
      }

      function loadData() {
        const saved = localStorage.getItem("allData");
        if (saved) {
          allData = JSON.parse(saved);
        }
      }

      function renderNavigation() {
        const dynamicContainer = document.getElementById("dynamic-pages");
        dynamicContainer.innerHTML = "";

        Object.keys(allSchemas).forEach((name) => {
          const link = document.createElement("a");
          link.id = `link-${name}`;
          link.textContent = name;
          link.href = "#";
          link.onclick = () => showPageBySchema(name);
          dynamicContainer.appendChild(link);
        });
      }

      function renderSchemaDropdown() {
        const selector = document.getElementById("schemaSelector");
        selector.innerHTML = Object.keys(allSchemas)
          .map((name) => `<option value="${name}">${name}</option>`)
          .join("");
        selector.value = activeSchemaName || "";
      }

      function createSchemaPage(schemaName) {
        const schema = allSchemas[schemaName];
        const dynamicContainer = document.getElementById("pages");

        const page = document.createElement("div");
        page.className = "page";
        page.id = `page-${schemaName}`;

        page.innerHTML = `
		<div class="pageheader">${schemaName.toUpperCase()}</div>
		<div class="Main-container">
		  <div class="sub-container1">
			<label>${schemaName} Details</label>
			<button onclick="prevEntry('${schemaName}')">Previous</button>
			<span id="entryRecordLabel-${schemaName}">Record 1 of X</span>
			<button onclick="nextEntry('${schemaName}')">Next</button>
			<button class="toggle-btn1">+</button>
			<div class="section1">
			  <div id="formModeLabel-${schemaName}" style="margin-bottom:10px; font-weight:bold;"></div>
			  <form id="entryForm-${schemaName}" onsubmit="saveEntry(event, '${schemaName}')">
				<div id="formFields-${schemaName}"></div>
				<button type="submit">Save</button>
				<button type="button" onclick="updateEntry('${schemaName}')">Update</button>
				<button type="button" onclick="startNewEntry('${schemaName}')">New</button>
				<button type="button" onclick="deleteEntry('${schemaName}')">Delete</button>
			  </form>
			</div>
		  </div>

		  <div class="sub-container1">
			<label>${schemaName} Table</label>
			<button class="toggle-btn1">+</button>
			<div class="section1">
			  <section id="table-view-${schemaName}">
				<table id="dataTable-${schemaName}">
				  <thead></thead>
				  <tbody></tbody>
				</table>
			  </section>
			</div>
		  </div>

		  <div class="sub-container1">
			<label>${schemaName} Dashboard</label>
			<button class="toggle-btn1">+</button>
			<button onclick="downloadTableAsPDF('dashboardTable-${schemaName}', '${schemaName} Dashboard')">
			üìÑ Download Dashboard PDF
		  </button>
			<div class="section1">
			  <section id="Dashboard-${schemaName}">
				<span>Table Columns</span>
				<label><input type="checkbox" id="showSubTotal-${schemaName}" onchange="updateDashboard('${schemaName}')" /> Sub Total</label>
				<label><input type="checkbox" id="showGrandTotal-${schemaName}" onchange="updateDashboard('${schemaName}')" /> Grand Total</label>
				<div id="columnCheckboxes-${schemaName}" style="margin-top:10px;"></div>
				<table id="dashboardTable-${schemaName}">
				  <thead></thead>
				  <tbody></tbody>
				</table>
			  </section>
			</div>
		  </div>
		</div>
	  `;

        dynamicContainer.appendChild(page);

        // Attach toggle logic
        page.querySelectorAll(".toggle-btn1").forEach((button) => {
          const section = button
            .closest(".sub-container1")
            .querySelector(".section1");
          button.addEventListener("click", () => {
            section.classList.toggle("visible");
            button.textContent = section.classList.contains("visible")
              ? "‚àí"
              : "+";
          });
        });

        // Render form fields and table columns
        renderFormFields(schemaName);
        renderTableColumns(schemaName);
        renderDashboardCheckboxes(schemaName);
        updateDashboard(schemaName);
      }

      function updateDashboard(schemaName) {
        const table = document.getElementById(`dashboardTable-${schemaName}`);
        const thead = table.querySelector("thead");
        const tbody = table.querySelector("tbody");
        const columns = allSchemas[schemaName].columns;
        const entries = allData[schemaName] || [];

        const showSubTotal = document.getElementById(
          `showSubTotal-${schemaName}`
        ).checked;
        const showGrandTotal = document.getElementById(
          `showGrandTotal-${schemaName}`
        ).checked;

        // Get selected columns
        const selectedCols = Array.from(
          document.querySelectorAll(
            `#columnCheckboxes-${schemaName} input:checked`
          )
        ).map((cb) => cb.value);

        // Filter numeric columns
        const numericCols = columns.filter(
          (col) => selectedCols.includes(col.name) && col.type === "number"
        );

        // Filter by month/year if Date column exists
        const dateCol = columns.find((col) => col.type === "date");
        let filteredEntries = [...entries];

        if (dateCol) {
          const monthVal = document.getElementById(
            `monthFilter-${schemaName}`
          ).value;
          const yearVal = document.getElementById(
            `yearFilter-${schemaName}`
          ).value;

          filteredEntries = filteredEntries.filter((entry) => {
            const d = new Date(entry[dateCol.name]);
            if (!(d instanceof Date) || isNaN(d)) return false;
            const matchMonth = monthVal
              ? (d.getMonth() + 1).toString() === monthVal
              : true;
            const matchYear = yearVal
              ? d.getFullYear().toString() === yearVal
              : true;
            return matchMonth && matchYear;
          });
        }

        // Build header
        thead.innerHTML =
          "<tr>" +
          selectedCols.map((name) => `<th>${name}</th>`).join("") +
          (showGrandTotal ? "<th>Grand Total</th>" : "") +
          "</tr>";

        // Build rows
        tbody.innerHTML = "";
        filteredEntries.forEach((entry, index) => {
          let rowTotal = 0;
          const row = document.createElement("tr");

          selectedCols.forEach((name) => {
            let cellValue = entry[name] || "";
            if (name === "S.No") cellValue = index + 1;
            if (numericCols.some((col) => col.name === name)) {
              rowTotal += parseFloat(entry[name]) || 0;
            }
            row.innerHTML += `<td>${cellValue}</td>`;
          });

          if (showGrandTotal) {
            row.innerHTML += `<td><strong>${rowTotal}</strong></td>`;
          }

          tbody.appendChild(row);
        });

        // Add Sub Total row
        if (showSubTotal) {
          const totalRow = document.createElement("tr");

          selectedCols.forEach((name) => {
            const colDef = columns.find((col) => col.name === name);

            if (name === "S.No") {
              totalRow.innerHTML += `<td><strong>TOTAL</strong></td>`;
            } else if (numericCols.some((col) => col.name === name)) {
              const sum = filteredEntries.reduce(
                (acc, entry) => acc + (parseFloat(entry[name]) || 0),
                0
              );
              totalRow.innerHTML += `<td><strong>${sum}</strong></td>`;
            } else {
              totalRow.innerHTML += `<td></td>`;
            }
          });

          if (showGrandTotal) {
            const grandSum = filteredEntries.reduce((acc, entry) => {
              return (
                acc +
                numericCols.reduce(
                  (sum, col) => sum + (parseFloat(entry[col.name]) || 0),
                  0
                )
              );
            }, 0);
            totalRow.innerHTML += `<td><strong>${grandSum}</strong></td>`;
          }

          tbody.appendChild(totalRow);
        }
      }

      function renderDashboardCheckboxes(schemaName) {
        const container = document.getElementById(
          `columnCheckboxes-${schemaName}`
        );
        container.innerHTML = "";

        const columns = allSchemas[schemaName].columns;
        const entries = allData[schemaName] || [];

        // Column checkboxes
        columns.forEach((col) => {
          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.value = col.name;
          checkbox.checked = true;
          checkbox.onchange = () => updateDashboard(schemaName);

          const label = document.createElement("label");
          label.style.marginRight = "10px";
          label.appendChild(checkbox);
          label.appendChild(
            document.createTextNode(" " + (col.label || col.name))
          );

          container.appendChild(label);
        });

        // Date filters if Date column exists
        const dateCol = columns.find((col) => col.type === "date");
        if (dateCol) {
          const months = [
            ...new Set(
              entries
                .map((e) => {
                  const d = new Date(e[dateCol.name]);
                  return d instanceof Date && !isNaN(d)
                    ? d.getMonth() + 1
                    : null;
                })
                .filter((m) => m !== null)
            ),
          ].sort((a, b) => a - b);

          const years = [
            ...new Set(
              entries
                .map((e) => {
                  const d = new Date(e[dateCol.name]);
                  return d instanceof Date && !isNaN(d)
                    ? d.getFullYear()
                    : null;
                })
                .filter((y) => y !== null)
            ),
          ].sort((a, b) => a - b);

          const monthSelect = document.createElement("select");
          monthSelect.id = `monthFilter-${schemaName}`;
          monthSelect.innerHTML =
            `<option value="">All Months</option>` +
            months
              .map(
                (m) =>
                  `<option value="${m}">${m
                    .toString()
                    .padStart(2, "0")}</option>`
              )
              .join("");
          monthSelect.onchange = () => updateDashboard(schemaName);

          const yearSelect = document.createElement("select");
          yearSelect.id = `yearFilter-${schemaName}`;
          yearSelect.innerHTML =
            `<option value="">All Years</option>` +
            years.map((y) => `<option value="${y}">${y}</option>`).join("");
          yearSelect.onchange = () => updateDashboard(schemaName);

          container.appendChild(document.createTextNode(" | Filter by: "));
          container.appendChild(monthSelect);
          container.appendChild(yearSelect);
        }
      }

      function nextEntry(schemaName) {
        const entries = allData[schemaName];
        if (!entries || entries.length === 0) return;

        let index = currentEntryIndex[schemaName];
        if (index == null || index >= entries.length - 1) return;

        currentEntryIndex[schemaName] = index + 1;
        showEntry(schemaName);
      }

      function prevEntry(schemaName) {
        const entries = allData[schemaName];
        if (!entries || entries.length === 0) return;

        let index = currentEntryIndex[schemaName];
        if (index == null || index <= 0) return;

        currentEntryIndex[schemaName] = index - 1;
        showEntry(schemaName);
      }

      function startNewEntry(schemaName) {
        currentEntryIndex[schemaName] = -1;
        const form = document.querySelectorAll(
          `#formFields-${schemaName} input`
        );
        form.forEach((input) => (input.value = ""));
        document.getElementById(`formModeLabel-${schemaName}`).textContent =
          "New Entry";
        alert(
          `üÜï New entry initialized for schema: "${schemaName}". You can now fill in the fields.`
        );
      }

      function showEntry(schemaName) {
        const index = currentEntryIndex[schemaName];
        const entries = allData[schemaName];

        if (index == null || index < 0 || index >= entries.length) {
          console.warn("‚ö†Ô∏è Invalid index for showEntry:", index);
          return;
        }

        const entry = entries[index];
        const inputs = document.querySelectorAll(
          `#formFields-${schemaName} input`
        );
        inputs.forEach((input) => {
          input.value = entry[input.name] ?? "";
        });

        document.getElementById(
          `formModeLabel-${schemaName}`
        ).textContent = `Entry ${index + 1} of ${entries.length}`;
      }

      function populateForm(schemaName, entry) {
        const schema = schemaMap[schemaName];
        schema.forEach((field) => {
          const input = document.querySelector(`[name="${field.name}"]`);
          if (input) input.value = entry[field.name] ?? "";
        });
      }

      function renderTable(schemaName) {
        const table = document.getElementById(`dataTable-${schemaName}`);
        if (!table) {
          console.warn(`‚ö†Ô∏è Table not found for schema: ${schemaName}`);
          return;
        }

        const tbody = table.querySelector("tbody");
        const entries = allData[schemaName] || [];
        const schema = allSchemas[schemaName].columns;

        tbody.innerHTML = "";

        entries.forEach((entry, index) => {
          const row = document.createElement("tr");
          row.onclick = () => {
            currentEntryIndex[schemaName] = index;
            showEntry(schemaName);
          };
          row.innerHTML = schema
            .map((col) => `<td>${entry[col.name] || ""}</td>`)
            .join("");
          tbody.appendChild(row);
        });

        document.getElementById(
          `entryRecordLabel-${schemaName}`
        ).textContent = `Total: ${entries.length}`;
      }

      function renderFormFields(schemaName, entry = {}) {
        const schema = allSchemas[schemaName].columns;
        const container = document.getElementById(`formFields-${schemaName}`);
        container.innerHTML = "";

        schema.forEach((col) => {
          if (col.name === "S.No") return;

          const wrapper = document.createElement("label");
          wrapper.style.display = "block";

          const label = document.createElement("span");
          label.textContent = col.label || col.name;

          const input = document.createElement("input"); // ‚úÖ FIXED: Declare input
          input.name = col.name;
          input.type = col.type || "text";
          input.required = col.required || false;
          input.value = entry[col.name] ?? "";

          input.addEventListener("input", () => {
            evaluateLiveFormulas(schemaName);
          });

          wrapper.appendChild(label);
          wrapper.appendChild(input);
          container.appendChild(wrapper);
        });
      }

      function evaluateLiveFormulas(schemaName) {
        const schemaCols = allSchemas[schemaName].columns;
        const inputs = document.querySelectorAll(
          `#formFields-${schemaName} input`
        );
        const entry = {};

        inputs.forEach((input) => {
          const colDef = schemaCols.find((c) => c.name === input.name);
          const raw = input.value;

          // ‚úÖ Convert to number if type is number
          entry[input.name] =
            colDef?.type === "number" ? parseFloat(raw) || 0 : raw;
        });

        schemaCols.forEach((col) => {
          if (col.formula) {
            try {
              const context = { ...entry };
              const result = Function(
                ...Object.keys(context),
                `return ${col.formula}`
              )(...Object.values(context));
              const targetInput = document.querySelector(
                `#formFields-${schemaName} input[name="${col.name}"]`
              );
              if (targetInput) targetInput.value = result;
            } catch (err) {
              console.warn(`‚ö†Ô∏è Live formula error in "${col.name}":`, err);
            }
          }
        });
      }

      function renderTableColumns(schemaName) {
        const schema = allSchemas[schemaName].columns;
        const table = document.getElementById(`dataTable-${schemaName}`);
        const thead = table.querySelector("thead");
        thead.innerHTML = "";

        const headerRow = document.createElement("tr");
        schema.forEach((col) => {
          const th = document.createElement("th");
          th.textContent = col.label || col.name;
          headerRow.appendChild(th);
        });

        thead.appendChild(headerRow);
      }

      function addSidebarLink(schemaName) {
        const sidebarContainer = document.getElementById("dynamic-pages");

        // Avoid duplicate links
        if (document.getElementById(`link-${schemaName}`)) return;

        const link = document.createElement("a");
        link.id = `link-${schemaName}`;
        link.textContent = schemaName;
        link.href = "#";
        link.onclick = () => showPageBySchema(schemaName);

        sidebarContainer.appendChild(link);
      }

      function showPageBySchema(schemaName) {
        // Activate page and sidebar link
        document
          .querySelectorAll(".page")
          .forEach((p) => p.classList.remove("active"));
        document
          .querySelectorAll("#dynamic-pages a")
          .forEach((link) => link.classList.remove("active"));

        const targetPage = document.getElementById(`page-${schemaName}`);
        const targetLink = document.getElementById(`link-${schemaName}`);

        if (targetPage) targetPage.classList.add("active");
        if (targetLink) targetLink.classList.add("active");

        // Hide menu
        menuVisible = false;
        document.getElementById("sideMenu").style.left = "-200px";

        // ‚úÖ Load schema data and render
        activeSchemaName = schemaName;
        schema = allSchemas[schemaName].columns || [];
        data = allData[schemaName] || [];
        currentColIndex = 0;

        // ‚úÖ Ensure entry index is initialized
        if (currentEntryIndex[schemaName] == null) {
          currentEntryIndex[schemaName] = data.length > 0 ? 0 : -1;
        }

        renderColumnForm();
        renderFormFields(schemaName);
        renderTableColumns(schemaName);
        renderTable(schemaName);
        showEntry(schemaName);
      }

      function saveData() {
        localStorage.setItem("allData", JSON.stringify(allData));

        // ‚úÖ Sync each schema's data to SchemaDB ‚Üí navigationMeta
        const request = indexedDB.open("SchemaDB", 1);
        request.onsuccess = function (event) {
          const db = event.target.result;
          const tx = db.transaction("navigationMeta", "readwrite");
          const store = tx.objectStore("navigationMeta");

          for (const schemaId in allData) {
            store.put({ id: schemaId, data: allData[schemaId] });
          }

          tx.oncomplete = () =>
            console.log("‚úÖ Synced allData to navigationMeta");
          tx.onerror = () =>
            console.error("‚ùå Failed to sync allData to navigationMeta");
        };
      }

      function showEntry(schemaName) {
        const index = currentEntryIndex[schemaName];
        const entries = allData[schemaName] || [];

        if (index == null || index < 0 || index >= entries.length) {
          console.warn("‚ö†Ô∏è Invalid index for showEntry:", index);
          return;
        }

        const entry = entries[index];
        renderFormFields(schemaName, entry); // ‚úÖ Pass entry directly

        document.getElementById(
          `formModeLabel-${schemaName}`
        ).textContent = `Entry ${index + 1} of ${entries.length}`;
      }

      function startNewEntry(schemaName) {
        currentEntryIndex[schemaName] = -1;

        const schemaCols = allSchemas[schemaName].columns;
        const inputs = document.querySelectorAll(
          `#formFields-${schemaName} input`
        );
        const entry = {};

        // Step 1: Clear all inputs
        inputs.forEach((input) => {
          input.value = "";
          entry[input.name] = "";
        });

        // Step 2: Evaluate default formulas
        schemaCols.forEach((col) => {
          if (col.formula) {
            try {
              const context = { ...entry };
              const result = Function(
                ...Object.keys(context),
                `return ${col.formula}`
              )(...Object.values(context));
              const targetInput = document.querySelector(
                `#formFields-${schemaName} input[name="${col.name}"]`
              );
              if (targetInput) targetInput.value = result;
            } catch (err) {
              console.warn(`‚ö†Ô∏è Formula error in "${col.name}":`, err);
            }
          }
        });

        // Step 3: Update label
        document.getElementById(`formModeLabel-${schemaName}`).textContent =
          "New Entry";
        alert(
          `üÜï New entry initialized for schema: "${schemaName}". Default values applied.`
        );
      }

      function updateEntry(schemaName) {
        const index = currentEntryIndex[schemaName];
        if (index == null || index < 0) {
          alert("‚ö†Ô∏è No entry selected to update.");
          return;
        }

        const inputs = document.querySelectorAll(
          `#formFields-${schemaName} input`
        );
        const entry = {};

        inputs.forEach((input) => {
          entry[input.name] = input.value;
        });

        // ‚úÖ Preserve S.No
        entry["S.No"] = allData[schemaName][index]["S.No"];

        allData[schemaName][index] = entry;
        saveData();
        renderTable(schemaName);
        showEntry(schemaName);
        alert("‚úÖ Entry updated.");
      }

      function deleteEntry(schemaName) {
        const index = currentEntryIndex[schemaName];
        if (index == null || index < 0) {
          alert("‚ö†Ô∏è No entry selected to delete.");
          return;
        }
        const request = indexedDB.open("SchemaDB", 1);
        request.onsuccess = function (event) {
          const db = event.target.result;

          // Remove from schemas
          const tx1 = db.transaction("schemas", "readwrite");
          tx1.objectStore("schemas").delete(name);

          // Remove from navigationMeta
          const tx2 = db.transaction("navigationMeta", "readwrite");
          tx2.objectStore("navigationMeta").delete(name);

          console.log(`üóëÔ∏è Removed "${name}" from IndexedDB`);
        };

        if (!confirm("Are you sure you want to delete this entry?")) return;

        allData[schemaName].splice(index, 1);
        currentEntryIndex[schemaName] = allData[schemaName].length > 0 ? 0 : -1;

        saveData();
        renderTable(schemaName);

        if (currentEntryIndex[schemaName] >= 0) {
          showEntry(schemaName);
        } else {
          startNewEntry(schemaName);
        }

        alert("üóëÔ∏è Entry deleted.");
      }

      async function downloadTableAsPDF(tableId, title = "Table Export") {
        const table = document.getElementById(tableId);
        if (!table) return alert(`‚ùå Table with ID "${tableId}" not found.`);

        const canvas = await html2canvas(table, {
          scale: 2,
          useCORS: true,
        });

        const imgData = canvas.toDataURL("image/png");
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF("p", "mm", "a4");

        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();

        const imgProps = pdf.getImageProperties(imgData);
        const imgWidth = pageWidth - 28;
        const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

        const today = new Date().toLocaleDateString();
        pdf.setFont("helvetica", "bold");
        pdf.setFontSize(18);
        pdf.text("MAK PRINTERS", pageWidth / 2, 20, { align: "center" });

        pdf.setFont("helvetica", "normal");
        pdf.setFontSize(11);
        pdf.text(`Title: ${title}`, 14, 30);
        pdf.text(`Export Date: ${today}`, 14, 38);

        const contentY = 45;
        const availableHeight = pageHeight - contentY - 30;

        if (imgHeight > availableHeight) {
          pdf.addImage(imgData, "PNG", 14, contentY, imgWidth, availableHeight);
        } else {
          pdf.addImage(imgData, "PNG", 14, contentY, imgWidth, imgHeight);
        }

        pdf.setFont("helvetica", "italic");
        pdf.setFontSize(10);
        pdf.text("Generated by MAK Dashboard", pageWidth / 2, pageHeight - 15, {
          align: "center",
        });

        const safeTitle = title.replace(/\s+/g, "_");
        pdf.save(`${safeTitle}_${today}.pdf`);
      }

      window.onload = () => {
        initSchemaDB(); // ‚úÖ Create stores if missing
        loadSchemas(); // ‚úÖ Load schema structure
        loadData(); // ‚úÖ Load saved entries

        renderSchemaDropdown(); // ‚úÖ Populate dropdown
        renderNavigation(); // ‚úÖ Rebuild side menu links

        Object.keys(allSchemas).forEach((name) => {
          createSchemaPage(name); // ‚úÖ Recreate page DOM
          addSidebarLink(name); // ‚úÖ Add sidebar link
        });

        if (activeSchemaName) {
          onSchemaChange(activeSchemaName); // ‚úÖ Load active schema
        }

        // ‚úÖ Initialize other modules
        initDB?.();
        initInvoicetaxdb?.();
        tryPopulateDashboard?.();
      };

      // ‚úÖ Expose globally
      window.createNewSchema = createNewSchema;
      window.deleteSchema = deleteSchema;
      window.updateEntry = updateEntry;
      window.deleteEntry = deleteEntry;
      window.startNewEntry = startNewEntry;
      window.prevEntry = prevEntry;
      window.nextEntry = nextEntry;
    </script>
  </body>
</html>
